<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Lector ticket Mercadona</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Modo oscuro automático -->
<script>
(function(){
  const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
  function applyTheme(e){ 
    if (e.matches) document.documentElement.setAttribute('data-bs-theme','dark');
    else document.documentElement.removeAttribute('data-bs-theme');
  }
  if (mq){ applyTheme(mq); mq.addEventListener('change', applyTheme); }
})();
</script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<!-- Librerías -->
<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
<script src="https://unpkg.com/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* Dropdown de categorías (form manual) */
.cat-dd-btn { display:flex; align-items:center; justify-content:space-between; width:100%; }
.cat-dd-label { display:inline-flex; align-items:center; gap:.5rem; }
.cat-dd-item { display:flex; align-items:center; gap:.5rem; width:100%; }
.cat-dd-dot { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,.25); }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
.mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

/* Chips antiguas desactivadas (ya no se usan en tabla) */
.chip { display:none; }

/* Fila coloreada (dinámica por categoría) */
.row-colored { box-shadow: inset 4px 0 0 0 var(--cat-color, transparent); }

/* Resumen */
.catsum-grid { display:flex; flex-wrap:wrap; gap:.5rem; }
.catsum-grid .tag { display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border-radius:.5rem; background:#f8f9fa; border:1px solid #e9ecef; font-size:.9rem; cursor:pointer; }
.catsum-grid .n { font-variant-numeric: tabular-nums; }

/* Marcas de precio */
.price-flag { font-size:.95em; margin-right:.35rem; vertical-align:text-top; }
.pf-low{color:#198754;} .pf-high{color:#dc3545;} .pf-mid{color:#f59e0b;} .pf-eq{color:#6b7280;}

/* Subrayado sólo en texto, no icono */
a.desc-link { text-decoration:none; }
a.desc-link .desc-text { text-decoration:underline; text-underline-offset:2px; }

/* Tabla responsive */
.table-wrap { width:100%; overflow-x:auto; }
th.th-desc,td.td-desc{max-width:40ch;overflow-wrap:anywhere;word-break:break-word;}
.table thead th{white-space:nowrap;position:sticky;top:0;z-index:2;background:var(--bs-tertiary-bg,#f8f9fa);}

/* Dark Mode */
:root[data-bs-theme="dark"] body.bg-light { background:#0b0f14!important; color:#ddd; }
:root[data-bs-theme="dark"] .table thead{background:#111827;color:#eee;}
:root[data-bs-theme="dark"] .catsum-grid .tag{background:#12161c;border-color:#202938;}
:root[data-bs-theme="dark"] a.desc-link .desc-text{color:#cbd5e1;}

/* Formulario corrección manual */
#manualFix .form-text{margin-top:.25rem;}
#manualFix .input-group-text{min-width:2.25rem;justify-content:center;}
@media(max-width:576px){
  .table{font-size:.95rem;}
  td,th{padding:.5rem;}
  td.td-desc,th.th-desc{max-width:26ch;}
}
.btn-del { line-height: 1; padding: .1rem .35rem; }

/* Navbar categorías */
.catbar { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.catbtn { display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--bs-border-color, #e5e7eb); background: var(--bs-body-bg, #fff); padding:.25rem .5rem; border-radius: 999px; cursor:pointer; }
.cat-swatch { width:14px; height:14px; border-radius:50%; border:1px solid rgba(0,0,0,.2); display:inline-block; }
.catbtn.active { outline:2px solid currentColor; outline-offset:2px; }
.catbtn .name { font-size:.9rem; }
.catbar .sep { width:1px; height:20px; background:var(--bs-border-color, #e5e7eb); margin:0 .25rem; }
.catbar .btn-none { border-style:dashed; }
.cat-new { display:flex; align-items:center; gap:.35rem; }
.cat-new input[type="text"] { width:11ch; }
.cat-new input[type="color"] { width:32px; height:32px; padding:0; border:1px solid var(--bs-border-color, #e5e7eb); border-radius:6px; }

/* Fixed navbar spacing */
body { padding-top: 64px; }
@media (max-width:576px){ body { padding-top: 84px; } }

/* Fila asignada (color visible) */
.row-assigned {
  background-color: var(--cat-bg) !important;
  box-shadow: inset 6px 0 0 0 var(--cat-color);
  transition: background-color .15s ease;
}
.row-assigned:hover { filter: brightness(1.02); }

/* Pintar todas las celdas cuando hay categoría (como en old.html) */
.row-assigned > * { background-color: var(--cat-bg) !important; }

/* Columna de categoría con bolita de color */
.cat-cell { white-space: nowrap; }
.cat-dot { display:inline-block; width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.25); margin-right:.4rem; vertical-align:middle; }
.cat-name { vertical-align:middle; }

/* --- Export card styles (restored) --- */
.export-card {
  width: 900px; background: #ffffff; color: #111827;
  border: 1px solid #e5e7eb; border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  padding: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
.export-card h2 { margin: 0 0 8px; font-size: 20px; }
.export-card .meta { font-size: 12px; color: #6b7280; margin-bottom: 10px; }
.export-card table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
.export-card th, .export-card td { border: 1px solid #e5e7eb; padding: 8px; }
.export-card th { text-align: left; background: #f9fafb; }
.export-card .right { text-align: right; font-variant-numeric: tabular-nums; }
.export-card .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
.export-card .total { font-weight: 700; }
/* keep export root offscreen */
#export-root { position: fixed; left: -200vw; top: 0; }
</style>
</head>
<body class="bg-light">
<div class="container py-3">

  <!-- Navbar con título y selector de categorías -->
  <nav class="navbar fixed-top bg-body-tertiary shadow-sm p-2">
    <div class="container-fluid p-0">
      <div class="d-flex flex-wrap align-items-center justify-content-between w-100 gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="navbar-brand mb-0 h6">Lector ticket (Mercadona)</span>
          <small id="progress" class="text-muted"></small>
        </div>
        <div class="catbar" id="catBar"><!-- Render por JS --></div>
      </div>
    </div>
  </nav>

  <input id="file" type="file" accept="application/pdf" class="form-control my-2">

  <div id="meta" class="small text-muted"></div>
  <div id="check" class="mb-2"></div>

  <div class="table-wrap card shadow-sm">
    <table class="table table-sm align-middle mb-0" id="tbl">
      <thead>
        <tr>
          <th style="width:90px;">Nº</th>
          <th class="th-desc">
            Descripción
            <button id="btnSort" type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0" title="Cambiar orden">A→Z</button>
          </th>
          <th style="width:180px;">Categoría</th>
          <th class="text-end" style="width:140px;">Importe (€)</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="4" class="text-muted">Selecciona un PDF…</td></tr></tbody>
    </table>
  </div>

  <div id="catsum" class="mt-2"></div>

  <div class="d-grid mt-2">
    <button id="btnExport" class="btn btn-outline-secondary" disabled>Exportar resumen</button>
  </div>

  <div id="manualFix" class="card mt-3 d-none">
    <div class="card-body">
      <div id="diffMsg" class="mb-2 small"></div>
      <form id="manualForm" class="row g-2 align-items-end">
        <div class="col-12 col-sm-6">
          <label class="form-label small mb-1">Descripción</label>
          <input id="mfDesc" type="text" class="form-control" placeholder="Ej. línea faltante">
        </div>
        <div class="col-6 col-sm-3">
          <label class="form-label small mb-1">Importe</label>
          <div class="input-group">
            <span class="input-group-text">€</span>
            <input id="mfAmount" type="text" class="form-control mono" value="0,00" inputmode="decimal" autocomplete="off">
          </div>
        </div>
        <div class="col-6 col-sm-3">
          <label class="form-label small mb-1">Categoría</label>
          <div id="mfCatWrap" class="dropdown w-100"></div>
          <input id="mfCatVal" type="hidden" value="">
        </div>
        <div class="col-12">
          <button id="btnAddManual" class="btn btn-sm btn-warning">Añadir línea</button>
        </div>
      </form>
    </div>
  </div>

  <div id="export-root" style="position:fixed;left:-200vw;top:0;"></div>
</div>

<script>
/* ------------ ELEMENTOS Y ESTADO ------------ */
const $file = document.getElementById('file');
const $tbl = document.getElementById('tbl').querySelector('tbody');
const $progress = document.getElementById('progress');
const $meta = document.getElementById('meta');
const $check = document.getElementById('check');
const $catsum = document.getElementById('catsum');
const $btnExport = document.getElementById('btnExport');
const $exportRoot = document.getElementById('export-root');

let lastCheckOk = null;
let lastExpected = NaN;
let lastCalc = NaN;
let lastFilename = '';

/* Categorías por fila (key -> categoryId) */
const categoryMap = new Map();
let currentItems = [];
let itemsByKey = new Map();
function itemKey(it) {
  return [String(it.quantity), String(it.description), String(it.unit), String(it.amount)].join('|');
}

/* Líneas manuales y base */
let manualItems = [];
let baseItems = [];

/* Orden */
let sortMode = 'alpha';

/* -------- CATEGORÍAS DINÁMICAS (NAVBAR) -------- */
let categories = [];
let activeCategoryId = null;

function hexToRGBA(hex, alpha=0.2){
  hex = String(hex||'').trim();
  const m = hex.match(/^#?([0-9a-f]{6})$/i);
  if(!m) return `rgba(0,0,0,${alpha})`;
  const i = parseInt(m[1],16);
  const r = (i>>16)&255, g=(i>>8)&255, b=i&255;
  return `rgba(${r},${g},${b},${alpha})`;
}
function defaultCategories(){
  return [
    {id:'alberto', name:'Alberto', color:'#dc3545', locked:true},
    {id:'kike',    name:'Kike',    color:'#0d6efd', locked:true},
    {id:'comun',   name:'Común',   color:'#ffc107', locked:true}
  ];
}
function loadCategories(){
  try{
    const raw = localStorage.getItem('mc_cats');
    const act = localStorage.getItem('mc_cats_active');
    categories = raw ? JSON.parse(raw) : defaultCategories();
    activeCategoryId = act || categories[0]?.id || null;
  }catch(e){
    categories = defaultCategories();
    activeCategoryId = categories[0]?.id || null;
  }
}
function saveCategories(){
  localStorage.setItem('mc_cats', JSON.stringify(categories));
  if (activeCategoryId !== null) localStorage.setItem('mc_cats_active', activeCategoryId);
}
function setActiveCategory(id){
  activeCategoryId = id || null;
  saveCategories();
  renderCatBar();
}
function renderCatBar(){
  const bar = document.getElementById('catBar');
  if (!bar) return;
  const btn = (c) => `
    <button type="button" class="catbtn ${activeCategoryId===c.id?'active':''}" data-cat-id="${c.id}" style="color:${c.color}">
      <span class="cat-swatch" style="background:${c.color}"></span>
      <span class="name">${escapeHtml(c.name)}</span>
    </button>`;
  const htmlCats = categories.map(btn).join('');
  const newForm = `
    <span class="sep"></span>
    <div class="cat-new" id="catNew">
      <input id="newCatName" type="text" class="form-control form-control-sm" placeholder="Nombre">
      <input id="newCatColor" type="color" value="#22c55e" aria-label="Color">
      <button id="newCatAdd" type="button" class="btn btn-sm btn-success">+</button>
    </div>`;
  bar.innerHTML = htmlCats + newForm;

  bar.querySelectorAll('.catbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-cat-id');
      if (!id) return;
      setActiveCategory(id);
    });
  });
  const addBtn = bar.querySelector('#newCatAdd');
  if (addBtn){
    addBtn.addEventListener('click', ()=>{
      const name = String(bar.querySelector('#newCatName').value||'').trim();
      const color = String(bar.querySelector('#newCatColor').value||'').trim();
      if (!name){ alert('Pon un nombre para la categoría'); return; }
      const id = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
      if (!/^#[0-9a-f]{6}$/i.test(color)){ alert('Color inválido'); return; }
      if (categories.some(c=>c.id===id)){ alert('Ya existe una categoría con ese nombre'); return; }
      categories.push({id, name, color, locked:false});
      setActiveCategory(id);
      saveCategories();
      const total = setTable(baseItems);
      lastCalc = total;
      setCheck(lastFilename || '', total);
      renderManualCatDropdown();
    });
  }
}

// Renderiza un dropdown Bootstrap con colores para la categoría del formulario manual
function renderManualCatDropdown(){
  const wrap = document.getElementById('mfCatWrap');
  const hidden = document.getElementById('mfCatVal');
  if (!wrap || !hidden) return;

  const def = activeCategoryId || (categories[0] && categories[0].id) || '';
  const defObj = categories.find(c => c.id === def) || categories[0] || {id:'', name:'', color:'#888'};
  hidden.value = defObj.id;

  wrap.innerHTML = `
    <button class="btn btn-outline-secondary dropdown-toggle cat-dd-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      <span class="cat-dd-label">
        <span class="cat-dd-dot" style="background:${defObj.color}"></span>
        <span class="cat-dd-name">${escapeHtml(defObj.name)}</span>
      </span>
    </button>
    <ul class="dropdown-menu w-100">
      ${categories.map(c => `
        <li>
          <button type="button" class="dropdown-item cat-dd-item" data-id="${c.id}" data-color="${c.color}">
            <span class="cat-dd-dot" style="background:${c.color}"></span>
            <span>${escapeHtml(c.name)}</span>
          </button>
        </li>
      `).join('')}
    </ul>
  `;

  wrap.querySelectorAll('.cat-dd-item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      const color = btn.getAttribute('data-color');
      const name = btn.textContent.trim();
      hidden.value = id;
      const lab = wrap.querySelector('.cat-dd-name');
      const dot = wrap.querySelector('.cat-dd-dot');
      if (lab) lab.textContent = name;
      if (dot) dot.style.background = color;
    });
  });
}

/* ------------ NUMÉRICO / FORMATO ------------ */
const toNumberEUR = (s) => {
  if (typeof s !== "string") s = String(s ?? "");
  s = s.replace(/\s+/g,"").replace(/[€\u0080]/g,"").replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return isFinite(n) ? n : NaN;
};
const toEUR = (n) => isFinite(n) ? n.toLocaleString("es-ES",{minimumFractionDigits:2, maximumFractionDigits:2}) : "0,00";
function nearlyEqual(a,b,eps=0.01){ return isFinite(a)&&isFinite(b)&&Math.abs(a-b) <= eps; }
function sanitizeAmountInput(str){
  if (typeof str !== 'string') str = String(str ?? '');
  str = str.trim().replace(/[€\s]/g,'').replace(/\./g,'').replace(',', '.');
  const n = Number(str);
  return isFinite(n) ? n : NaN;
}

/* ------------ PROGRESO / VALIDACIÓN ------------ */
function setProgress(msg){ $progress.textContent = msg || ""; }
function parseFilenameTotal(name){
  const m = String(name||"").match(/(\d{1,3}(?:\.\d{3})*,\d{2})/);
  return m ? toNumberEUR(m[1]) : NaN;
}
function setCheckNone(){ $check.innerHTML = '<span class="text-muted">— Validación pendiente —</span>'; }
function setCheck(filename, totalCalc){
  const expected = parseFilenameTotal(filename);
  let html = '';
  if (!isFinite(expected)) {
    html = '<div class="alert alert-secondary py-2 my-2" role="alert">No se encontró importe en el nombre del archivo.</div>';
    lastCheckOk = null; lastExpected = NaN; lastCalc = Number(totalCalc)||NaN; lastFilename = filename || '';
  } else if (nearlyEqual(expected, totalCalc)) {
    html = `<div class="alert alert-success fw-bold my-2" role="alert" style="font-size:1.05rem">
      ✅ Coincide — <span class="fw-normal">archivo: ${toEUR(expected)} • calculado: ${toEUR(totalCalc)}</span>
    </div>`;
    lastCheckOk = true; lastExpected = Number(expected); lastCalc = Number(totalCalc); lastFilename = filename || '';
  } else {
    html = `<div class="alert alert-danger fw-bold my-2" role="alert" style="font-size:1.05rem">
      ❌ No coincide — <span class="fw-normal">archivo: ${toEUR(expected)} • calculado: ${toEUR(totalCalc)}</span>
    </div>`;
    lastCheckOk = false; lastExpected = Number(expected); lastCalc = Number(totalCalc); lastFilename = filename || '';
  }
  $check.innerHTML = html;
  updateManualFixUI();
}

/* ------------ HELPERS TEXTO / BÚSQUEDA ------------ */
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeDescKey(s){
  s = String(s||'').toLowerCase();
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // tildes
  s = s.replace(/\s{2,}/g,' ').trim();
  return s;
}
function buildSearchURL(desc){
  const q = encodeURIComponent(`${String(desc||'').trim()} Mercadona`);
  return `https://www.google.com/search?tbm=isch&q=${q}`;
}

/* ------------ ICONOS PRECIO POR DESCRIPCIÓN ------------ */
function priceFlagForRole(role){
  switch(role){
    case 'low': return '<span class="price-flag pf-low" title="Más barato">▼</span>';
    case 'high': return '<span class="price-flag pf-high" title="Más caro">▲</span>';
    case 'mid': return '<span class="price-flag pf-mid" title="Precio intermedio">●</span>';
    case 'eq': return '<span class="price-flag pf-eq" title="Mismo precio">⚖️</span>';
    default: return '';
  }
}

/* ------------ RENDER TABLA ------------ */
function setTable(items){
  items = (items || []).slice();
  if (Array.isArray(manualItems) && manualItems.length){
    items = items.concat(manualItems);
  }
  if(!items || items.length===0){
    $tbl.innerHTML = `<tr><td colspan="4" class="text-muted">No se detectaron líneas de producto.</td></tr>`;
    setCheckNone();
    $catsum.textContent = '';
    currentItems = [];
    itemsByKey = new Map();
    categoryMap.clear();
    updateExportButtonState();
    return 0;
  }

  currentItems = items.slice();

  // Agrupar por descripción y asignar roles de precio
  const groups = new Map(); // descKey -> [{ key, amount }]
  const roleByKey = new Map(); // key -> 'low'|'high'|'mid'|'eq'
  for (const r of currentItems){
    const key = itemKey(r);
    const dkey = normalizeDescKey(r.description);
    if (!groups.has(dkey)) groups.set(dkey, []);
    groups.get(dkey).push({ key, amount: Number(r.amount)||0 });
  }
  for (const [, arr] of groups.entries()){
    if (arr.length <= 1){ roleByKey.set(arr[0].key, ''); continue; }
    let min = Infinity, max = -Infinity;
    for (const it of arr){ if (it.amount < min) min = it.amount; if (it.amount > max) max = it.amount; }
    const allEq = isFinite(min) && isFinite(max) && Math.abs(max - min) < 0.001;
    if (allEq){ for (const it of arr) roleByKey.set(it.key, 'eq'); }
    else {
      for (const it of arr){
        if (Math.abs(it.amount - min) < 0.001) roleByKey.set(it.key, 'low');
        else if (Math.abs(it.amount - max) < 0.001) roleByKey.set(it.key, 'high');
        else roleByKey.set(it.key, 'mid');
      }
    }
  }

  // Orden
  let sorted;
  if (sortMode === 'ticket') {
    sorted = currentItems.slice().sort((a,b) => {
      const oa = isFinite(a.origIndex) ? a.origIndex : Number.POSITIVE_INFINITY;
      const ob = isFinite(b.origIndex) ? b.origIndex : Number.POSITIVE_INFINITY;
      if (oa !== ob) return oa - ob;
      const da = normalizeDescKey(a.description);
      const db = normalizeDescKey(b.description);
      return da.localeCompare(db, 'es', { sensitivity:'base' });
    });
  } else {
    sorted = currentItems.slice().sort((a,b) => {
      const da = normalizeDescKey(a.description);
      const db = normalizeDescKey(b.description);
      const cmp = da.localeCompare(db, 'es', { sensitivity:'base' });
      if (cmp !== 0) return cmp;
      return (Number(a.amount)||0) - (Number(b.amount)||0);
    });
  }

  itemsByKey = new Map();
  let html = "";
  let total = 0;
  for(const r of sorted){
    const key = itemKey(r);
    itemsByKey.set(key, r);
    total += r.amount;

    const catId = categoryMap.get(key) || '';
    const catObj = categories.find(c => c.id === catId);
    const color = catObj ? catObj.color : '';
    const name  = catObj ? catObj.name  : '';
    const bg = color ? hexToRGBA(color, 0.22) : '';
    const style = color ? `style="--cat-color:${color}; --cat-bg:${bg}"` : '';
    const rowClass = catId ? 'row-assigned' : '';
    const role = (roleByKey.get(key) || '');
    const flag = priceFlagForRole(role);

    html += `<tr data-key="${escapeHtml(key)}"
                 data-manual-id="${r.manualId ? escapeHtml(String(r.manualId)) : ''}"
                 data-cat-id="${catId}"
                 class="${rowClass}"
                 ${style}>
      <td class="mono">
        ${r.manualId
          ? `<button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar línea manual">✖</button>`
          : `${escapeHtml(String(r.quantity))}`
        }
      </td>
      <td class="td-desc">
        <a class="desc-link" href="${buildSearchURL(r.description)}" target="_blank" rel="noopener">
          ${flag}<span class="desc-text">${escapeHtml(r.description)}</span>
        </a>
      </td>
      <td class="cat-cell">
        ${catId
          ? `<span class="cat-dot" style="background:${color}"></span><span class="cat-name">${escapeHtml(name)}</span>`
          : `—`
        }
      </td>
      <td class="text-end mono">${toEUR(r.amount)}</td>
    </tr>`;
  }
  html += `<tr class="table-light">
    <td></td>
    <td class="fw-bold">TOTAL</td>
    <td></td>
    <td class="text-end mono fw-bold">${toEUR(total)}</td>
  </tr>`;
  $tbl.innerHTML = html;

  updateCategorySummary();
  updateExportButtonState();
  return total;
}

/* ------------ RESUMEN Y COPIAR TOTALES ------------ */
function updateCategorySummary() {
  const sums = {};
  for (const c of categories) sums[c.id] = { n:0, total:0, color:c.color, name:c.name };
  for (const [key, catId] of categoryMap.entries()) {
    const it = itemsByKey.get(key);
    if (!it || !(catId in sums)) continue;
    sums[catId].n += 1;
    sums[catId].total += Number(it.amount) || 0;
  }
  const parts = categories.map(c=>{
    const s = sums[c.id];
    return `<span class="tag" data-total="${toEUR(s.total)}" title="Click para copiar total de ${escapeHtml(c.name)}" style="border-color:${c.color}22;">
              <span class="cat-swatch" style="background:${c.color}"></span>
              <strong style="color:${c.color}">${escapeHtml(c.name)}</strong>
              <span class="n">(${s.n}) ${toEUR(s.total)}</span>
            </span>`;
  }).join('');
  $catsum.innerHTML = '<div class="catsum-grid">' + parts + '</div>';
}
$catsum.addEventListener('click', async (ev) => {
  const tag = ev.target.closest('.tag');
  if (!tag) return;
  const val = tag.getAttribute('data-total') || '';
  try {
    await navigator.clipboard.writeText(val);
    const old = tag.innerHTML;
    tag.innerHTML = old + ' <span class="ms-1">📋</span>';
    setTimeout(() => { tag.innerHTML = old; }, 1000);
  } catch(e){
    alert('No se pudo copiar al portapapeles');
  }
});

/* ------------ EXPORTAR COMO IMAGEN ------------ */
function buildExportCard(catObj, items) {
  const wrap = document.createElement('div');
  wrap.className = 'export-card';
  const total = items.reduce((a,b)=> a + (Number(b.amount)||0), 0);
  wrap.innerHTML = `
    <h2 style="color:${catObj.color}">Lista ${escapeHtml(catObj.name)}</h2>
    <table>
      <thead>
        <tr>
          <th style="width:100px;">Nº</th>
          <th>Descripción</th>
          <th class="right" style="width:150px;">Importe (€)</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(it => `
          <tr>
            <td class="mono">${escapeHtml(String(it.quantity))}</td>
            <td>${escapeHtml(String(it.description))}</td>
            <td class="right mono">${toEUR(Number(it.amount))}</td>
          </tr>
        `).join('')}
        <tr>
          <td></td>
          <td class="total">TOTAL</td>
          <td class="right mono total">${toEUR(total)}</td>
        </tr>
      </tbody>
    </table>
  `;
  return wrap;
}
async function exportCategoryImages() {
  if (!window.html2canvas) { alert('No se pudo cargar html2canvas.'); return; }
  if (lastCheckOk === false) {
    const msg = `⚠️ El total calculado (${toEUR(lastCalc)}) NO coincide con el del archivo (${toEUR(lastExpected)}).\n\n¿Quieres exportar igualmente?`;
    if (!confirm(msg)) return;
  }
  // Construir map dinámico por categoría
  const byCat = {};
  for (const c of categories) byCat[c.id] = [];
  for (const tr of document.querySelectorAll('#tbl tbody tr[data-key]')) {
    const key = tr.getAttribute('data-key');
    if (!key) continue;
    const catId = categoryMap.get(key);
    const it = itemsByKey.get(key);
    if (catId && it && byCat[catId]) byCat[catId].push(it);
  }
  const wrapper = document.createElement('div');
  wrapper.style.width = '980px';
  wrapper.style.background = '#fff';
  wrapper.style.padding = '16px';
  wrapper.style.border = '1px solid #e5e7eb';
  wrapper.style.borderRadius = '12px';
  wrapper.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';

  const title = document.createElement('h1');
  title.textContent = 'Resumen por categorías';
  title.style.fontSize = '22px';
  title.style.margin = '0 0 10px';
  wrapper.appendChild(title);

  const meta = document.createElement('div');
  meta.textContent = new Date().toLocaleString('es-ES');
  meta.style.color = '#6b7280';
  meta.style.fontSize = '12px';
  meta.style.marginBottom = '12px';
  wrapper.appendChild(meta);

  let added = 0;
  for (const c of categories) {
    const arr = byCat[c.id] || [];
    if (!arr.length) continue;
    const card = buildExportCard(c, arr);
    card.style.marginBottom = '16px';
    wrapper.appendChild(card);
    added++;
  }
  if (!added) { alert('No hay categorías con elementos para exportar.'); return; }

  $exportRoot.appendChild(wrapper);
  const canvas = await html2canvas(wrapper, { backgroundColor: '#ffffff', scale: 2, useCORS: true });
  const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'listas_categorias.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
  wrapper.remove();
}

/* ------------ PICKER AUTO / ESTADO EXPORT ------------ */
function updateExportButtonState() {
  const rows = Array.from(document.querySelectorAll('#tbl tbody tr[data-key]'));
  if (rows.length === 0) {
    $btnExport.disabled = true;
    $btnExport.title = 'No hay productos para exportar';
    return;
  }
  let assigned = 0;
  for (const tr of rows) {
    const key = tr.getAttribute('data-key');
    if (key && categoryMap.has(key)) assigned++;
  }
  const allAssigned = assigned === rows.length;
  $btnExport.disabled = !allAssigned;
  $btnExport.title = allAssigned
    ? 'Exportar una única imagen con todas las categorías'
    : 'Asigna categoría a todas las filas para exportar';
}

/* ------------ CLIC EN FILA (asignación) ------------ */
document.getElementById('tbl').addEventListener('click', (ev) => {
  const tr = ev.target.closest('tr[data-key]');
  if (!tr) return;
  if (ev.target.closest('.btn-del')) return;
  const key = tr.getAttribute('data-key');
  if (!key) return;

  if (!activeCategoryId) {
    if (categoryMap.has(key)) categoryMap.delete(key);
  } else {
    const prev = categoryMap.get(key);
    if (prev === activeCategoryId) categoryMap.delete(key);
    else categoryMap.set(key, activeCategoryId);
  }
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
});
document.getElementById('tbl').addEventListener('dblclick', (ev) => {
  const tr = ev.target.closest('tr[data-key]');
  if (!tr) return;
  const key = tr.getAttribute('data-key');
  if (!key) return;
  if (categoryMap.has(key)) categoryMap.delete(key);
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
});

// Eliminar línea manual con botón ✖
document.getElementById('tbl').addEventListener('click', (ev) => {
  const del = ev.target.closest('.btn-del');
  if (!del) return;
  const tr = del.closest('tr');
  if (!tr) return;
  const mid = tr.getAttribute('data-manual-id');
  if (!mid) return;

  const idx = manualItems.findIndex(it => String(it.manualId) === String(mid));
  if (idx === -1) return;
  const it = manualItems[idx];
  const k = itemKey(it);
  if (categoryMap.has(k)) categoryMap.delete(k);
  manualItems.splice(idx, 1);
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
}, true);

/* ------------ PDF -> TEXTO ------------ */
async function pdfToTextLines(buf){
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const lines = [];
  let textItems = 0;
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    textItems += (content.items||[]).length;
    const byY = new Map();
    for(const it of content.items){
      const str = it.str || "";
      const tr = it.transform; const y = tr ? tr[5] : 0; const x = tr ? tr[4] : 0;
      const key = Math.round(y/2);
      if(!byY.has(key)) byY.set(key, []);
      byY.get(key).push({x, text: str});
    }
    const ys = Array.from(byY.keys()).sort((a,b)=>b-a);
    for(const y of ys){
      const chunks = byY.get(y).sort((a,b)=>a.x-b.x).map(c=>c.text);
      const line = chunks.map(c=>String(c||"").trim()).join(" ").replace(/\s{2,}/g," ").trim();
      if(line) lines.push(line);
    }
  }
  return {lines, textItems};
}

/* ------------ OCR (fallback) ------------ */
async function pdfToTextLinesOCR(buf){
  if(!window.Tesseract) throw new Error("No se cargó Tesseract.js");
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const lines = [];
  for(let p=1;p<=pdf.numPages;p++){
    setProgress(`OCR página ${p}/${pdf.numPages}…`);
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({scale: 2});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', {willReadFrequently:true});
    canvas.width = Math.ceil(viewport.width);
    canvas.height = Math.ceil(viewport.height);
    await page.render({canvasContext:ctx, viewport}).promise;
    const dataUrl = canvas.toDataURL('image/png');
    const res = await Tesseract.recognize(dataUrl, 'spa+eng', { logger: () => {} });
    const text = res.data && res.data.text ? res.data.text : "";
    const pageLines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    lines.push(...pageLines);
  }
  return lines;
}

/* ------------ HEURÍSTICAS ------------ */
function normalizeLine(s){
  s = String(s||"");
  s = s.replace(/(\d)[oO](\d)/g, '$10$2');
  s = s.replace(/,(\d)[sS]\b/g, ',$15');
  s = s.replace(/,(\d)[oO]\b/g, ',$10');
  s = s.replace(/\s*[€\u0080]\s*/g, ' €');
  s = s.replace(/\s{2,}/g,' ').trim();
  return s;
}
function findLastPrice(str){
  const s = normalizeLine(str);
  const m = s.match(/(\d{1,3}(?:\.\d{3})*,\d{1,2})(?:\s*[€\u0080])?(?!.*\d)/);
  if (!m) return null;
  let val = m[1];
  if (/,\d$/.test(val)) val = val + '0';
  return val;
}
function nextNonEmpty(arr, i){
  let j = i+1;
  while(j < arr.length){
    const s = String(arr[j]||"").trim();
    if (s) return { index: j, text: s };
    j++;
  }
  return { index: -1, text: "" };
}
function filterProductsSection(lines){
  const L = lines.map(s => normalizeLine(String(s||"").trim()));
  const looksLikeProduct = (s, next) =>
    /^\s*\d+\s+.+\s+\d+,\d{2}(?:\s+\d+,\d{2})?\s*$/.test(s) ||
    (/^\D{2,}$/.test(s) && /\b(kg|g|l)\b.*\d+,\d{2}.*\d+,\d{2}/i.test(next||"")) ||
    (/^\s*\d+\s+\D+/.test(s) && /\b(kg|g|l)\b.*\d+,\d{2}.*\d+,\d{2}/i.test((next||""))) ||
    (/^\s*\d+\s+\D+/.test(s) && !!findLastPrice(next||""));

  let start = -1, end = L.length;
  for (let i=0;i<L.length;i++){
    const s = L[i] && L[i].trim();
    if (!s) continue;
    if (/^TOTAL\b/i.test(s) || /^TOTAL\s*[:€]/i.test(s) || /^TOTAL\s+(\d+|\d{1,3}(\.\d{3})*,\d{2})/i.test(s)) {
      end = i; break;
    }
  }
  for (let i=0;i<end;i++){
    const s = L[i] && L[i].trim(); if(!s) continue;
    const { text: next } = nextNonEmpty(L, i);
    if (looksLikeProduct(s, next)) { start = i; break; }
  }
  if (start >= 0) return L.slice(start, end).filter(Boolean);
  return L.filter(Boolean);
}
function parseProducts(lines){
  const isNoise = (s) => /(IVA\b|BASE IMPONIBLE|CUOTA\b|TARJ|MASTERCARD|EFECTIVO|FACTURA|SE ADMITEN DEVOLUCIONES|CAMBIO)/i.test(s);
  const clean = (s) => String(s||"").replace(/\s{2,}/g," ").trim();

  const out = [];
  const push = (q, d, u, a) => {
    const quantity = Number(String(q).replace(",", "."));
    const amount = toNumberEUR(a);
    let unit = u ? toNumberEUR(u) : NaN;
    if(!isFinite(unit) || unit<=0){ unit = quantity>0 ? amount/quantity : amount; }
    if(!isFinite(quantity) || quantity<=0 || !isFinite(amount)) return;
    if(!d || d.length<2) return;
    out.push({quantity, description:d, unit:Number(unit.toFixed(2)), amount:Number(amount.toFixed(2))});
  };

  const N = lines.map(clean).map(normalizeLine).filter(Boolean);

  for(let i=0;i<N.length;i++){
    const row = N[i];
    if (/^TOTAL\b/i.test(row) || /^TOTAL\s*[:€]/i.test(row)) break;
    if (isNoise(row)) continue;

    let m = row.match(/^\s*(\d+)\s+(.+?)\s+(\d+,\d{2})(?:\s*[€\u0080])?\s+(\d+,\d{2})(?:\s*[€\u0080])?.*$/);
    if(m){ push(m[1], m[2], m[3], m[4]); continue; }

    m = row.match(/^\s*(\d+)\s+(.+?)\s+(\d+,\d{2})(?:\s*[€\u0080])?.*$/);
    if(m){ push(m[1], m[2], null, m[3]); continue; }

    if(/^\D{2,}$/.test(row)){
      const { index: j, text: next } = nextNonEmpty(N, i);
      if (j !== -1) {
        const m2 = next.match(/^\s*([\d.,]+)\s*(kg|g|l)\b.*?(\d+,\d{2}).*?(\d+,\d{2})\s*$/i);
        if(m2){
          const qtyW = Number(m2[1].replace(",", "."));
          push(qtyW, row, m2[3], m2[4]);
          i = j;
          continue;
        }
      }
    }

    m = row.match(/^\s*(\d+)\s+(.+?)\s*$/);
    if(m){
      const desc = m[2];
      const { index: j, text: next } = nextNonEmpty(N, i);
      if (j !== -1) {
        const m2 = next.match(/^\s*([\d.,]+)\s*(kg|g|l)\b.*?(\d+,\d{2}).*?(\d+,\d{2})\s*$/i);
        if (m2){
          const qtyW = Number(m2[1].replace(",", "."));
          push(qtyW, desc, m2[3], m2[4]);
          i = j;
          continue;
        }
      }
    }

    // "1 DESCRIPCIÓN" + siguiente con precio al final
    m = row.match(/^\s*(\d+)\s+(.+?)\s*$/);
    if (m) {
      const qty = m[1];
      const desc = m[2];
      const { index: j, text: next } = nextNonEmpty(N, i);
      if (j !== -1) {
        const p = findLastPrice(next);
        if (p) {
          push(qty, desc, null, p);
          i = j;
          continue;
        }
      }
    }

    const euros = row.match(/\d+,\d{2}/g);
    if(euros && euros.length>=1){
      const amount = euros[euros.length-1];
      const unit = euros.length>=2 ? euros[euros.length-2] : null;
      const leadQty = row.match(/^\s*(\d+)\s+/);
      const qty = leadQty ? Number(leadQty[1]) : 1;
      const cut = row.lastIndexOf(amount);
      let desc = row.substring(leadQty ? leadQty[0].length : 0, cut).trim();
      if(!desc) desc = row.replace(new RegExp(amount+"\\s*$"), "").trim();
      if (/^(TOTAL|IVA|BASE IMPONIBLE|CUOTA)\b/i.test(desc)) continue;
      push(qty, desc, unit, amount);
      continue;
    } else {
      const p = findLastPrice(row);
      if (p) {
        const leadQty = row.match(/^\s*(\d+)\s+/);
        const qty = leadQty ? Number(leadQty[1]) : 1;
        const cut = row.lastIndexOf(p);
        let desc = row.substring(leadQty ? leadQty[0].length : 0, cut).trim();
        if(!desc) desc = row.replace(new RegExp(p+"\\s*$"), "").trim();
        if (!/^(TOTAL|IVA|BASE IMPONIBLE|CUOTA)\b/i.test(desc)) {
          push(qty, desc, null, p);
          continue;
        }
      }
    }
  }
  return out;
}

function extractMeta(lines){
  const txt = lines.join("\n");
  const date = (txt.match(/\b(\d{2}\/\d{2}\/\d{4})\b/)||[])[1] || "";
  const time = (txt.match(/\b(\d{2}:\d{2})\b/)||[])[1] || "";
  const tienda = (txt.match(/MERCADONA/i) ? "Mercadona" : "");
  $meta.textContent = [tienda && `Comercio: ${tienda}`, (date||time) && `Fecha/Hora: ${date} ${time}`].filter(Boolean).join("\n");
}

/* ------------ PROCESO PRINCIPAL ------------ */
async function processSelectedFile(){
  const f = $file.files && $file.files[0];
  if(!f){ return; }
  if(!/\.pdf$/i.test(f.name)){ alert("Debe ser un PDF."); return; }
  try{
    setProgress("Cargando PDF...");
    const buf = new Uint8Array(await f.arrayBuffer());
    let lines = [];
    const {lines: lns, textItems} = await pdfToTextLines(buf);
    lines = lns;
    if(!lines.length || textItems===0){
      setProgress("Sin texto embebido. Haciendo OCR…");
      lines = await pdfToTextLinesOCR(buf);
    }
    setProgress("Extrayendo productos…");
    extractMeta(lines);
    const section = filterProductsSection(lines);
    const items = parseProducts(section);
    categoryMap.clear();
    manualItems = [];
    baseItems = items.slice();
    baseItems.forEach((it, idx) => { it.origIndex = idx; });
    const total = setTable(baseItems);
    setCheck(f.name, total);
    setProgress("");
  } catch (e){
    console.error(e);
    alert("No se pudo procesar el PDF.");
    setProgress("");
  }
}

/* ------------ UI CORRECCIÓN MANUAL ------------ */
function getRemaining(){
  if (!isFinite(lastExpected) || !isFinite(lastCalc)) return 0;
  return lastExpected - lastCalc;
}
function updateManualFixUI(){
  const box = document.getElementById('manualFix');
  const msg = document.getElementById('diffMsg');
  const amtInput = document.getElementById('mfAmount');
  const canCompare = isFinite(lastExpected) && isFinite(lastCalc);
  if (!box || !msg || !amtInput) return;
  if (!canCompare){
    box.classList.add('d-none');
    return;
  }
  const diff = getRemaining();
  const abs = Math.abs(diff);
  const falta = diff > 0.005;
  const sobra = diff < -0.005;

  if (falta) {
    msg.innerHTML = `<div class="alert alert-warning py-2 my-0" role="alert">
      Falta <strong>${toEUR(abs)}</strong> para cuadrar con el total del archivo.
    </div>`;
    const valNow = toNumberEUR(amtInput.value);
    if (!isFinite(valNow) || valNow <= 0) amtInput.value = toEUR(abs);
    document.getElementById('btnAddManual').disabled = false;
    box.classList.remove('d-none');
  } else if (sobra) {
    msg.innerHTML = `<div class="alert alert-danger py-2 my-0" role="alert">
      Sobra <strong>${toEUR(abs)}</strong> respecto al total del archivo. Revisa las líneas detectadas.
    </div>`;
    amtInput.value = toEUR(0);
    document.getElementById('btnAddManual').disabled = true;
    box.classList.remove('d-none');
  } else {
    box.classList.add('d-none');
    return;
  }
}

/* ------------ EVENTOS ------------ */
$file.addEventListener('change', processSelectedFile);

// Saneo en vivo del importe manual
const $mfAmount = document.getElementById('mfAmount');
$mfAmount.addEventListener('input', () => {
  const n = sanitizeAmountInput($mfAmount.value);
  const rem = getRemaining();
  const over = isFinite(n) && n - rem > 0.005;
  $mfAmount.classList.toggle('is-invalid', !!over);
});
$mfAmount.addEventListener('blur', () => {
  const n = sanitizeAmountInput($mfAmount.value);
  if (isFinite(n) && n > 0) $mfAmount.value = toEUR(n);
});

// Añadir línea manual
document.getElementById('manualForm').addEventListener('submit', (ev) => {
  ev.preventDefault();
  const desc = document.getElementById('mfDesc').value.trim();
  const cat = document.getElementById('mfCatVal').value;
  const amtStr = document.getElementById('mfAmount').value;
  const amtNum = sanitizeAmountInput(amtStr);
  const rem = getRemaining();

  if (!desc) { alert('Introduce una descripción.'); return; }
  if (!isFinite(amtNum) || amtNum <= 0){ alert('Importe inválido.'); return; }
  if (!(rem > 0.005)) { alert('Ahora mismo no falta importe (o sobra).'); return; }
  if ((amtNum - rem) > 0.005) {
    alert(`El importe supera lo que falta por ajustar (${toEUR(rem)}).`);
    return;
  }

  const it = {
    quantity: 1,
    description: desc,
    unit: amtNum,
    amount: amtNum,
    manualId: Date.now() + '_' + Math.random().toString(36).slice(2,7),
    origIndex: Number.POSITIVE_INFINITY
  };
  manualItems.push(it);

  const key = itemKey(it);
  if (cat) categoryMap.set(key, cat);

  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);

  document.getElementById('mfDesc').value = '';
  const newRem = getRemaining();
  document.getElementById('mfAmount').value = newRem > 0.005 ? toEUR(newRem) : toEUR(0);
  document.getElementById('mfDesc').focus();
});

// Export
$btnExport.addEventListener('click', exportCategoryImages);

// Auto-abrir picker + inicializar categorías y botón de orden
document.addEventListener('DOMContentLoaded', () => {
  const openPicker = () => {
    try {
      if (!$file.files || $file.files.length === 0) {
        if (typeof $file.showPicker === 'function') $file.showPicker();
        else $file.click();
      }
    } catch(e){}
  };
  setTimeout(openPicker, 300);
  const onceOpen = () => { openPicker(); window.removeEventListener('pointerdown', onceOpen); window.removeEventListener('keydown', onceOpen); };
  window.addEventListener('pointerdown', onceOpen, { once:true });
  window.addEventListener('keydown', onceOpen, { once:true });

  loadCategories();
  renderCatBar();
  updateManualFixUI();
  renderManualCatDropdown();

  // Botón de orden en cabecera
  const $btnSort = document.getElementById('btnSort');
  if ($btnSort) {
    const refreshLabel = () => { $btnSort.textContent = (sortMode === 'alpha') ? 'A→Z' : 'Ticket'; };
    refreshLabel();
    $btnSort.addEventListener('click', () => {
      sortMode = (sortMode === 'alpha') ? 'ticket' : 'alpha';
      refreshLabel();
      const total = setTable(baseItems);
      lastCalc = total;
      setCheck(lastFilename || '', total);
    });
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>