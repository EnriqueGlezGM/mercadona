<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Lector ticket Mercadona</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Modo oscuro autom√°tico -->
<script>
(function(){
  const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
  function applyTheme(e){ 
    if (e.matches) document.documentElement.setAttribute('data-bs-theme','dark');
    else document.documentElement.removeAttribute('data-bs-theme');
  }
  if (mq){ applyTheme(mq); mq.addEventListener('change', applyTheme); }
})();
</script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<!-- Librer√≠as -->
<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
<script src="https://unpkg.com/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* Dropdown de categor√≠as (form manual) */
.cat-dd-btn { display:flex; align-items:center; justify-content:space-between; width:100%; }
.cat-dd-label { display:inline-flex; align-items:center; gap:.5rem; }
.cat-dd-item { display:flex; align-items:center; gap:.5rem; width:100%; }
.cat-dd-dot { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,.25); }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
:root {
  --glass-bg: rgba(255, 255, 255, 0.58);
  --glass-border: rgba(255, 255, 255, 0.46);
  --glass-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
  --surface-bg: linear-gradient(180deg, #eef2ff 0%, #f8fbff 45%, #e0e7ff 100%);
  --safe-bottom: env(safe-area-inset-bottom, 16px);
}
:root[data-bs-theme="dark"] {
  --glass-bg: rgba(15, 23, 42, 0.68);
  --glass-border: rgba(148, 163, 184, 0.28);
  --glass-shadow: 0 22px 50px rgba(2, 6, 23, 0.6);
  --surface-bg: linear-gradient(180deg, #0b1220 0%, #141c2c 42%, #0a0f1c 100%);
}
body.bg-light {
  background: var(--surface-bg);
  background-attachment: fixed;
  min-height: 100vh;
}
.app-shell {
  position: relative;
  z-index: 1;
}
.glass-header {
  max-width: 420px;
  margin: 0 auto;
  padding: 1.5rem 1.75rem;
  border-radius: 28px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(22px);
  box-shadow: var(--glass-shadow);
  overflow: hidden;
}
.card {
  border: 1px solid var(--glass-border);
  background: var(--glass-bg);
  backdrop-filter: blur(18px);
  box-shadow: var(--glass-shadow);
}
.mercadona-logo {
  display: block;
  max-width: 100%;         /* no superar el ancho de la burbuja */
  width: auto;
  height: auto;
  max-height: 92px;        /* adapta el alto para que no se recorte */
  margin-inline: auto;     /* centrado horizontal */
  filter: drop-shadow(0 12px 24px rgba(15, 23, 42, 0.2));
}

@media (max-width: 576px){
  .mercadona-logo{
    max-height: 72px;  /* un poco m√°s bajo en m√≥vil */
  }
}
.glass-title {
  font-weight: 600;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: rgba(15, 23, 42, 0.68);
}
#progress {
  color: rgba(15, 23, 42, 0.6);
}
:root[data-bs-theme="dark"] #progress {
  color: rgba(226, 232, 240, 0.7);
}
:root[data-bs-theme="dark"] .glass-title {
  color: rgba(226, 232, 240, 0.7);
}
.form-control,
.form-select,
.input-group-text {
  border-radius: 14px;
  border-color: rgba(148, 163, 184, 0.35);
  background: rgba(255, 255, 255, 0.72);
  backdrop-filter: blur(14px);
}
.input-group-text {
  background: rgba(255, 255, 255, 0.65);
}
:root[data-bs-theme="dark"] .form-control,
:root[data-bs-theme="dark"] .form-select,
:root[data-bs-theme="dark"] .input-group-text {
  background: rgba(15, 23, 42, 0.75);
  border-color: rgba(148, 163, 184, 0.28);
  color: #e2e8f0;
}
.btn-outline-secondary {
  border-color: rgba(148, 163, 184, 0.45);
  color: #0f172a;
  background: rgba(255, 255, 255, 0.55);
  backdrop-filter: blur(12px);
}
.btn-outline-secondary:hover,
.btn-outline-secondary:focus {
  color: #0f172a;
  background: rgba(255, 255, 255, 0.72);
}
:root[data-bs-theme="dark"] .btn-outline-secondary {
  color: #e2e8f0;
  border-color: rgba(148, 163, 184, 0.4);
  background: rgba(15, 23, 42, 0.7);
}
.mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

/* Chips antiguas desactivadas (ya no se usan en tabla) */
.chip { display:none; }

/* Fila coloreada (din√°mica por categor√≠a) */
.row-colored { box-shadow: inset 4px 0 0 0 var(--cat-color, transparent); }

/* Resumen */
.catsum-grid { display:flex; flex-wrap:wrap; gap:.5rem; }
.catsum-grid .tag {
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  padding:.35rem .65rem;
  border-radius:.75rem;
  background:rgba(255,255,255,0.68);
  border:1px solid var(--glass-border);
  font-size:.9rem;
  cursor:pointer;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
  backdrop-filter: blur(14px);
}
.catsum-grid .n { font-variant-numeric: tabular-nums; }

/* Marcas de precio */
.price-flag { font-size:.95em; margin-right:.35rem; vertical-align:text-top; }
.pf-low{color:#198754;} .pf-high{color:#dc3545;} .pf-mid{color:#f59e0b;} .pf-eq{color:#6b7280;}

/* Subrayado s√≥lo en texto, no icono */
a.desc-link { text-decoration:none; }
a.desc-link .desc-text { text-decoration:underline; text-underline-offset:2px; }

/* Tabla responsive */
.table-wrap { width:100%; overflow-x:auto; }
th.th-desc,td.td-desc{max-width:40ch;overflow-wrap:anywhere;word-break:break-word;}
.table thead th{
  white-space:nowrap;
  position:sticky;
  top:0;
  z-index:2;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(14px);
}

/* Dark Mode */
:root[data-bs-theme="dark"] body.bg-light { background:var(--surface-bg)!important; color:#e2e8f0; }
:root[data-bs-theme="dark"] .table thead th{background:rgba(15,23,42,0.82);color:#e2e8f0;}
:root[data-bs-theme="dark"] .catsum-grid .tag{
  background:rgba(15,23,42,0.78);
  border-color:rgba(148,163,184,0.28);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
}
:root[data-bs-theme="dark"] a.desc-link .desc-text{color:#cbd5e1;}

/* Formulario correcci√≥n manual */
#manualFix .form-text{margin-top:.25rem;}
#manualFix .input-group-text{min-width:2.25rem;justify-content:center;}
@media(max-width:576px){
  .table{font-size:.95rem;}
  td,th{padding:.5rem;}
  td.td-desc,th.th-desc{max-width:26ch;}
}
.btn-del { line-height: 1; padding: .1rem .35rem; }

/* Nav inferior tipo glass */
.glass-nav {
  border: 0;
  padding: 0 0 calc(1.2rem + var(--safe-bottom)) 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0), rgba(226, 232, 240, 0.65));
}
:root[data-bs-theme="dark"] .glass-nav {
  background: linear-gradient(180deg, rgba(15, 23, 42, 0), rgba(15, 23, 42, 0.78));
}
.glass-nav .container {
  display: flex;
  justify-content: center;
}
.glass-nav-dock {
  flex: 1;
  max-width: 540px;
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: .65rem .85rem;
  border-radius: 999px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  backdrop-filter: blur(20px);
  overflow: hidden;           /* que nada sobresalga de la burbuja */
  position: relative;         /* contexto para el bot√≥n + si se posiciona */
}
.catbar-scroll {
  flex: 1 1 auto;
  min-width: 0;
  overflow-x: auto;     /* scroll horizontal SOLO para las categor√≠as */
  overflow-y: visible;  /* no recortar relieves de chips */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  padding-top: 2px;     /* holgura para sombras/relieves */
  padding-bottom: 2px;
  padding-right: 68px;  /* deja sitio al bot√≥n + para que nunca lo tape el scroll */
  white-space: nowrap;  /* evita saltos de l√≠nea de los chips */
}
.catbar-scroll::-webkit-scrollbar { display: none; }
.catbar {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding-right: .25rem;
  flex-wrap: nowrap;   /* evita wraps que rompan el alto del dock */
}
.catbtn {
  display: inline-flex;
  align-items: center;
  gap: .4rem;
  padding: .35rem .8rem;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.45);
  background: rgba(255, 255, 255, 0.62);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.4);
  backdrop-filter: blur(12px);
  cursor: pointer;
  transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
  font-weight: 500;
}
.catbtn:hover { transform: translateY(-1px); }
.catbtn.active {
  background: rgba(255, 255, 255, 0.85);
  box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
  transform: none; /* no subir: evitamos que la parte superior se 'meta' debajo del contenedor */
}
.catbtn:focus-visible {
  outline: 2px solid currentColor;
  outline-offset: 3px;
}
.catbtn .name { font-size: .9rem; }
.cat-swatch {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.6);
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.05);
}
:root[data-bs-theme="dark"] .catbtn {
  border-color: rgba(148, 163, 184, 0.3);
  background: rgba(15, 23, 42, 0.72);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
}
:root[data-bs-theme="dark"] .catbtn.active {
  background: rgba(30, 41, 59, 0.95);
  box-shadow: 0 14px 28px rgba(2, 6, 23, 0.6);
}
:root[data-bs-theme="dark"] .catbtn.active { transform: none; }
.glass-fab {
  flex: 0 0 auto;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 1px solid var(--glass-border);
  background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(255,255,255,0.7));
  color: #0f172a;
  font-size: 2rem;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  align-self: center; /* asegurar centrado vertical dentro del dock */
  box-shadow: var(--glass-shadow);
  backdrop-filter: blur(18px);
  transition: transform .2s ease, box-shadow .2s ease;
  flex-shrink: 0;
}
.glass-fab span {
  display: block;
  line-height: 1;
  transform: translateY(-1px); /* ajuste √≥ptico para centrar el s√≠mbolo '+' */
}
.glass-fab:hover { transform: translateY(-2px); }
.glass-fab:active { transform: scale(.95); }
.glass-fab:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.8);
  outline-offset: 4px;
}
:root[data-bs-theme="dark"] .glass-fab {
  background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.78));
  color: #e2e8f0;
}

/* Spacer inferior controlado por JS */
body { padding-top: 0; padding-bottom: calc(4.5rem + var(--safe-bottom)); }
@media (max-width:576px){ body { padding-top: 0; } }
#nav-spacer { height: calc(4.5rem + var(--safe-bottom)); }

/* Fila asignada (color visible) */
.row-assigned {
  background-color: var(--cat-bg) !important;
  box-shadow: inset 6px 0 0 0 var(--cat-color);
  transition: background-color .15s ease;
}
.row-assigned:hover { filter: brightness(1.02); }

/* Pintar todas las celdas cuando hay categor√≠a (como en old.html) */
.row-assigned > * { background-color: var(--cat-bg) !important; }

/* Columna de categor√≠a con bolita de color */
.cat-cell { white-space: nowrap; text-align:center; }
.cat-dot { display:inline-block; width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.25); margin-right:.4rem; vertical-align:middle; }
.cat-name { vertical-align:middle; }

/* --- Export card styles (restored) --- */
.export-card {
  width: 900px; background: #ffffff; color: #111827;
  border: 1px solid #e5e7eb; border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  padding: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
.export-card h2 { margin: 0 0 8px; font-size: 20px; }
.export-card .meta { font-size: 12px; color: #6b7280; margin-bottom: 10px; }
.export-card table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
.export-card th, .export-card td { border: 1px solid #e5e7eb; padding: 8px; }
.export-card th { text-align: left; background: #f9fafb; }
.export-card .right { text-align: right; font-variant-numeric: tabular-nums; }
.export-card .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
.export-card .total { font-weight: 700; }
/* keep export root offscreen */
#export-root { position: fixed; left: -200vw; top: 0; }
/* Aumentar ligeramente el √°rea t√°ctil de las celdas (desktop) */
.table.table-sm td,
.table.table-sm th {
  padding: .7rem .75rem; /* antes ~.5rem */
}
/* En m√≥vil, un pel√≠n m√°s todav√≠a */
@media (max-width:576px){
  .table.table-sm td,
  .table.table-sm th { padding: .85rem .8rem; }
}
/* Solo el texto de la descripci√≥n es clicable (evitar que toda la celda lance el enlace) */
.td-desc .desc-link { display: inline; padding: 0; }
/* Asegurar capas correctas: el modal SIEMPRE por encima del backdrop */
.modal-backdrop { z-index: 2000 !important; }
.modal { z-index: 2001 !important; pointer-events: auto; }
/* Suavizar el backdrop y asegurar stacking */
.modal-backdrop.show { opacity: .5; }
/* Evitar que la barra inferior capture clics cuando el modal est√° abierto (NO desactivar app-shell) */
.modal-open .glass-nav { pointer-events: none; }
.modal-open .modal,
.modal-open .modal * { pointer-events: auto; }
</style>
</head>
<body class="bg-light">
<div class="app-shell container py-4 pb-5">

  <header class="glass-header text-center mb-4">
    <img src="https://cdn.worldvectorlogo.com/logos/mercadona.svg" alt="Mercadona" class="mercadona-logo">
    <p class="glass-title mb-0 mt-3">Lector de tickets</p>
    <small id="progress" class="text-muted d-block mt-2"></small>
  </header>

  <!-- Selector de archivo -->
  <input id="file" type="file" accept="application/pdf" class="form-control my-2">

  <div id="meta" class="small text-muted"></div>
  <div id="check" class="mb-2"></div>

  <!-- Tabla -->
  <div class="table-wrap card shadow-sm">
    <table class="table table-sm align-middle mb-0" id="tbl">
      <thead>
        <tr>
          <th style="width:90px;">N¬∫</th>
          <th class="th-desc">
            Descripci√≥n
            <button id="btnSort" type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0" title="Cambiar orden">A‚ÜíZ</button>
          </th>
          <th style="width:180px;"></th>
          <th class="text-end" style="width:140px;">Importe (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="4" class="text-muted">Selecciona un PDF‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <div id="catsum" class="mt-2"></div>

  <div class="d-grid mt-2">
    <button id="btnExport" class="btn btn-outline-secondary" disabled>Exportar resumen</button>
  </div>

  <!-- Correcci√≥n manual -->
  <div id="manualFix" class="card mt-3 d-none">
    <div class="card-body">
      <div id="diffMsg" class="mb-2 small"></div>
      <form id="manualForm" class="row g-2 align-items-end">
        <div class="col-12 col-sm-6">
          <label class="form-label small mb-1">Descripci√≥n</label>
          <input id="mfDesc" type="text" class="form-control" placeholder="Ej. l√≠nea faltante">
        </div>
        <div class="col-6 col-sm-3">
          <label class="form-label small mb-1">Importe</label>
          <div class="input-group">
            <span class="input-group-text">‚Ç¨</span>
            <input id="mfAmount" type="text" class="form-control mono" value="0,00" inputmode="decimal" autocomplete="off">
          </div>
        </div>
        <div class="col-6 col-sm-3">
          <label class="form-label small mb-1">Categor√≠a</label>
          <div id="mfCatWrap" class="dropdown w-100"></div>
          <input id="mfCatVal" type="hidden" value="">
        </div>
        <div class="col-12">
          <button id="btnAddManual" class="btn btn-sm btn-warning">A√±adir l√≠nea</button>
        </div>
      </form>
    </div>
  </div>

  <div id="export-root" style="position:fixed;left:-200vw;top:0;"></div>
  <div id="nav-spacer" aria-hidden="true"></div>
</div>

<!-- Barra inferior ‚Äúliquid glass‚Äù -->
<nav class="glass-nav fixed-bottom">
  <div class="container">
    <div class="glass-nav-dock">
      <div class="catbar-scroll">
        <div class="catbar" id="catBar"><!-- Render por JS --></div>
      </div>
      <button id="catAddBtn" class="glass-fab" type="button" aria-label="Nueva categor√≠a">
        <span aria-hidden="true">+</span>
      </button>
    </div>
  </div>
</nav>

  <!-- Modal: Crear/Editar/Eliminar categor√≠a -->
  <div class="modal fade" id="catEditModal" tabindex="-1" aria-labelledby="catEditLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="catEditLabel">Categor√≠a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="catEditForm" class="row g-3">
            <div class="col-8">
              <label for="catEditName" class="form-label small mb-1">Nombre</label>
              <input type="text" id="catEditName" class="form-control" maxlength="40" required>
            </div>
            <div class="col-4">
              <label for="catEditColor" class="form-label small mb-1">Color</label>
              <input type="color" id="catEditColor" class="form-control form-control-color" value="#22c55e" title="Elige color">
            </div>
          </form>
          <div id="catEditHint" class="form-text">Pulsa ‚ÄúGuardar‚Äù para aplicar los cambios.</div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" id="catEditDelete" class="btn btn-outline-danger d-none">Eliminar</button>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="catEditSave" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ------------ ELEMENTOS Y ESTADO ------------ */
const $file = document.getElementById('file');
const $tbl = document.getElementById('tbl').querySelector('tbody');
const $progress = document.getElementById('progress');
const $meta = document.getElementById('meta');
const $check = document.getElementById('check');
const $catsum = document.getElementById('catsum');
const $btnExport = document.getElementById('btnExport');
const $exportRoot = document.getElementById('export-root');
const $catAddBtn = document.getElementById('catAddBtn');

let lastCheckOk = null;
let lastExpected = NaN;
let lastCalc = NaN;
let lastFilename = '';

/* Categor√≠as por fila (key -> categoryId) */
const categoryMap = new Map();
let currentItems = [];
let itemsByKey = new Map();
function itemKey(it) {
  return [String(it.quantity), String(it.description), String(it.unit), String(it.amount)].join('|');
}

/* L√≠neas manuales y base */
let manualItems = [];
let baseItems = [];

/* Orden */
let sortMode = 'alpha';

/* -------- CATEGOR√çAS DIN√ÅMICAS (NAVBAR) -------- */
let categories = [];
let activeCategoryId = null;

// Estado edici√≥n de categor√≠a
let catEditId = null;
let catEditMode = 'edit';
let catEditModal = null;

function getCategoryById(id){ return categories.find(c => c.id === id); }
function slugifyName(name){
  return String(name || '')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'-').replace(/[^a-z0-9-]/gi,'')
    .slice(0, 40);
}
function hexToRGBA(hex, alpha=0.2){
  hex = String(hex||'').trim();
  const m = hex.match(/^#?([0-9a-f]{6})$/i);
  if(!m) return `rgba(0,0,0,${alpha})`;
  const i = parseInt(m[1],16);
  const r = (i>>16)&255, g=(i>>8)&255, b=i&255;
  return `rgba(${r},${g},${b},${alpha})`;
}
function defaultCategories(){
  return [
    {id:'alberto', name:'Alberto', color:'#dc3545', locked:true},
    {id:'kike',    name:'Kike',    color:'#0d6efd', locked:true},
    {id:'comun',   name:'Com√∫n',   color:'#ffc107', locked:true}
  ];
}
function loadCategories(){
  try{
    const raw = localStorage.getItem('mc_cats');
    const act = localStorage.getItem('mc_cats_active');
    categories = raw ? JSON.parse(raw) : defaultCategories();
    activeCategoryId = act || categories[0]?.id || null;
  }catch(e){
    categories = defaultCategories();
    activeCategoryId = categories[0]?.id || null;
  }
}
function saveCategories(){
  localStorage.setItem('mc_cats', JSON.stringify(categories));
  if (activeCategoryId !== null) localStorage.setItem('mc_cats_active', activeCategoryId);
}
function setActiveCategory(id){
  activeCategoryId = id || null;
  saveCategories();
  renderCatBar();
}

/* ---------- Footer spacer din√°mico ---------- */
function updateNavSpacer(){
  const nav = document.querySelector('.glass-nav.fixed-bottom');
  const sp = document.getElementById('nav-spacer');
  if (!nav || !sp) return;
  const rootStyles = getComputedStyle(document.documentElement);
  const safeRaw = rootStyles.getPropertyValue('--safe-bottom') || '16';
  const safe = parseFloat(safeRaw) || 16;
  const extra = Math.max(12, safe * 0.5);
  const h = nav.offsetHeight + extra;
  sp.style.height = h + 'px';
  document.body.style.paddingBottom = h + 'px';
}

/* ---------- Render footer categor√≠as ---------- */
function renderCatBar(){
  const bar = document.getElementById('catBar');
  if (!bar) return;
  if (!categories.length){
    bar.innerHTML = `<span class="text-muted small">A√±ade categor√≠as con el bot√≥n ‚Äú+‚Äù.</span>`;
    updateNavSpacer();
    return;
  }
  const htmlCats = categories.map((c) => `
    <button type="button" class="catbtn ${activeCategoryId===c.id?'active':''}" data-cat-id="${c.id}" style="color:${c.color}">
      <span class="cat-swatch" style="background:${c.color}"></span>
      <span class="name">${escapeHtml(c.name)}</span>
    </button>`).join('');
  bar.innerHTML = htmlCats;

  bar.querySelectorAll('.catbtn').forEach((b)=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-cat-id');
      if (!id) return;
      if (id === activeCategoryId) {
        openCategoryEditor(id, 'edit');
      } else {
        setActiveCategory(id);
      }
    });
  });
  updateNavSpacer();
}

/* ---------- Editor categor√≠a ---------- */
function openCategoryEditor(id, mode='edit'){
  const isCreate = mode === 'create';
  catEditMode = isCreate ? 'create' : 'edit';
  catEditId = isCreate ? null : (id || activeCategoryId);
  const cat = isCreate ? null : getCategoryById(catEditId);
  if (!isCreate && !cat) return;

  const $name = document.getElementById('catEditName');
  const $color = document.getElementById('catEditColor');
  const $title = document.getElementById('catEditLabel');
  const $hint = document.getElementById('catEditHint');
  const $save = document.getElementById('catEditSave');

  if ($name) $name.value = isCreate ? '' : (cat.name || '');
  if ($color) $color.value = isCreate
    ? '#22c55e'
    : (/^#[0-9a-f]{6}$/i.test(cat?.color || '') ? cat.color : '#22c55e');

  if ($title) $title.textContent = isCreate ? 'Nueva categor√≠a' : 'Editar categor√≠a';
  if ($hint) $hint.textContent = isCreate
    ? 'Pulsa ‚ÄúCrear‚Äù para a√±adir la nueva categor√≠a.'
    : 'Pulsa ‚ÄúGuardar‚Äù para aplicar los cambios.';
  if ($save) $save.textContent = isCreate ? 'Crear' : 'Guardar';

  updateCatEditDeleteBtn();

  if (!catEditModal){
    const $modal = document.getElementById('catEditModal');
    catEditModal = new bootstrap.Modal($modal, { backdrop: true, focus: true, keyboard: true });
  }
  catEditModal.show();
  // Enfocar el campo nombre tras abrir (evita quedarse "bloqueado" por falta de foco)
  setTimeout(()=>{ try{ document.getElementById('catEditName')?.focus(); }catch(e){} }, 50);
}

function updateCatEditDeleteBtn(){
  const delBtn = document.getElementById('catEditDelete');
  if (!delBtn) return;
  const isCreate = (catEditMode === 'create');
  // Ocultar en modo crear o si quedar√≠an menos de 2 categor√≠as tras borrar
  if (isCreate || categories.length <= 2){
    delBtn.classList.add('d-none');
    return;
  }
  delBtn.classList.remove('d-none');
}

function saveCategoryEditor(){
  const $name = document.getElementById('catEditName');
  const $color = document.getElementById('catEditColor');
  if (!$name || !$color) return;

  const newName = String($name.value || '').trim();
  const newColor = String($color.value || '').trim();

  if (!newName){ alert('Pon un nombre.'); return; }
  if (!/^#[0-9a-f]{6}$/i.test(newColor)){ alert('Color inv√°lido.'); return; }

  if (catEditMode === 'create'){
    const baseId = slugifyName(newName) || ('cat-' + Date.now().toString(36));
    let unique = baseId, k = 2;
    while (categories.some(c => c.id === unique)) unique = `${baseId}-${k++}`;
    const newCat = { id: unique, name: newName, color: newColor, locked: false };
    categories.push(newCat);
    activeCategoryId = newCat.id;
  } else {
    if (!catEditId) return;
    const cat = getCategoryById(catEditId);
    if (!cat) return;

    const oldId = cat.id;
    cat.name = newName;
    cat.color = newColor;

    // Permitimos renombrar incluso si era "locked"
    const proposed = slugifyName(newName) || oldId;
    if (proposed !== oldId){
      let unique = proposed, k=2;
      while (categories.some(c => c.id === unique && c !== cat)) unique = proposed + '-' + (k++);
      if (unique !== oldId){
        cat.id = unique;
        for (const [kkey, cid] of Array.from(categoryMap.entries())){
          if (cid === oldId) categoryMap.set(kkey, unique);
        }
        if (activeCategoryId === oldId) activeCategoryId = unique;
      }
    }
  }

  saveCategories();
  renderCatBar();
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
  renderManualCatDropdown();
  updateNavSpacer();

  if (catEditModal) catEditModal.hide();
  catEditId = null;
  catEditMode = 'edit';
}

function deleteCategoryEditor(){
  if (!catEditId) return;
  const cat = getCategoryById(catEditId);
  if (!cat) return;

  // Regla: no permitir que queden menos de 2 categor√≠as
  if (categories.length <= 2){
    alert('Debe haber al menos 2 categor√≠as. No se puede eliminar m√°s.');
    return;
  }

  const used = Array.from(categoryMap.values()).some(v => v === cat.id);
  const msg = used
    ? `La categor√≠a "${cat.name}" est√° asignada a algunas filas.\nSe eliminar√°n esas asignaciones. ¬øSeguro que quieres eliminarla?`
    : `¬øEliminar la categor√≠a "${cat.name}"?`;
  if (!confirm(msg)) return;

  // Eliminar asignaciones a esta categor√≠a
  for (const [k, v] of Array.from(categoryMap.entries())){
    if (v === cat.id) categoryMap.delete(k);
  }
  // Quitar de la lista de categor√≠as (incluye originales si toca)
  categories = categories.filter(c => c.id !== cat.id);

  // Ajustar activa
  if (activeCategoryId === cat.id){
    activeCategoryId = categories[0] ? categories[0].id : null;
  }

  saveCategories();
  renderCatBar();
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
  renderManualCatDropdown();
  updateNavSpacer();

  if (catEditModal) catEditModal.hide();
  catEditId = null;
  catEditMode = 'edit';
}

// Guardar / Eliminar desde el modal
document.addEventListener('click', (ev)=>{
  const saveBtn = ev.target.closest('#catEditSave');
  if (saveBtn){ saveCategoryEditor(); return; }
  const delBtn = ev.target.closest('#catEditDelete');
  if (delBtn){ deleteCategoryEditor(); return; }
});

/* ------------ NUM√âRICO / FORMATO ------------ */
const toNumberEUR = (s) => {
  if (typeof s !== "string") s = String(s ?? "");
  s = s.replace(/\s+/g,"").replace(/[‚Ç¨\u0080]/g,"").replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return isFinite(n) ? n : NaN;
};
const toEUR = (n) => isFinite(n) ? n.toLocaleString("es-ES",{minimumFractionDigits:2, maximumFractionDigits:2}) : "0,00";
function nearlyEqual(a,b,eps=0.01){ return isFinite(a)&&isFinite(b)&&Math.abs(a-b) <= eps; }
function sanitizeAmountInput(str){
  if (typeof str !== 'string') str = String(str ?? '');
  str = str.trim().replace(/[‚Ç¨\s]/g,'').replace(/\./g,'').replace(',', '.');
  const n = Number(str);
  return isFinite(n) ? n : NaN;
}

/* ------------ PROGRESO / VALIDACI√ìN ------------ */
function setProgress(msg){ $progress.textContent = msg || ""; }
function parseFilenameTotal(name){
  const m = String(name||"").match(/(\d{1,3}(?:\.\d{3})*,\d{2})/);
  return m ? toNumberEUR(m[1]) : NaN;
}
function setCheckNone(){ $check.innerHTML = '<span class="text-muted">‚Äî Validaci√≥n pendiente ‚Äî</span>'; }
function setCheck(filename, totalCalc){
  const expected = parseFilenameTotal(filename);
  let html = '';
  if (!isFinite(expected)) {
    html = '<div class="alert alert-secondary py-2 my-2" role="alert">No se encontr√≥ importe en el nombre del archivo.</div>';
    lastCheckOk = null; lastExpected = NaN; lastCalc = Number(totalCalc)||NaN; lastFilename = filename || '';
  } else if (nearlyEqual(expected, totalCalc)) {
    html = `<div class="alert alert-success fw-bold my-2" role="alert" style="font-size:1.05rem">
      ‚úÖ Coincide ‚Äî <span class="fw-normal">archivo: ${toEUR(expected)} ‚Ä¢ calculado: ${toEUR(totalCalc)}</span>
    </div>`;
    lastCheckOk = true; lastExpected = Number(expected); lastCalc = Number(totalCalc); lastFilename = filename || '';
  } else {
    html = `<div class="alert alert-danger fw-bold my-2" role="alert" style="font-size:1.05rem">
      ‚ùå No coincide ‚Äî <span class="fw-normal">archivo: ${toEUR(expected)} ‚Ä¢ calculado: ${toEUR(totalCalc)}</span>
    </div>`;
    lastCheckOk = false; lastExpected = Number(expected); lastCalc = Number(totalCalc); lastFilename = filename || '';
  }
  $check.innerHTML = html;
  updateManualFixUI();
}

/* ------------ HELPERS TEXTO / B√öSQUEDA ------------ */
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeDescKey(s){
  s = String(s||'').toLowerCase();
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // tildes
  s = s.replace(/\s{2,}/g,' ').trim();
  return s;
}
function buildSearchURL(desc){
  const q = encodeURIComponent(`${String(desc||'').trim()} Mercadona`);
  return `https://www.google.com/search?tbm=isch&q=${q}`;
}

/* ------------ ICONOS PRECIO POR DESCRIPCI√ìN ------------ */
function priceFlagForRole(role){
  switch(role){
    case 'low': return '<span class="price-flag pf-low" title="M√°s barato">‚ñº</span>';
    case 'high': return '<span class="price-flag pf-high" title="M√°s caro">‚ñ≤</span>';
    case 'mid': return '<span class="price-flag pf-mid" title="Precio intermedio">‚óè</span>';
    case 'eq': return '<span class="price-flag pf-eq" title="Mismo precio">‚öñÔ∏è</span>';
    default: return '';
  }
}

/* ------------ RENDER TABLA ------------ */
function setTable(items){
  items = (items || []).slice();
  if (Array.isArray(manualItems) && manualItems.length){
    items = items.concat(manualItems);
  }
  if(!items || items.length===0){
    $tbl.innerHTML = `<tr><td colspan="4" class="text-muted">No se detectaron l√≠neas de producto.</td></tr>`;
    setCheckNone();
    $catsum.textContent = '';
    currentItems = [];
    itemsByKey = new Map();
    categoryMap.clear();
    updateExportButtonState();
    return 0;
  }

  currentItems = items.slice();

  // Agrupar por descripci√≥n y asignar roles de precio
  const groups = new Map(); // descKey -> [{ key, amount }]
  const roleByKey = new Map(); // key -> 'low'|'high'|'mid'|'eq'
  for (const r of currentItems){
    const key = itemKey(r);
    const dkey = normalizeDescKey(r.description);
    if (!groups.has(dkey)) groups.set(dkey, []);
    groups.get(dkey).push({ key, amount: Number(r.amount)||0 });
  }
  for (const [, arr] of groups.entries()){
    if (arr.length <= 1){ roleByKey.set(arr[0].key, ''); continue; }
    let min = Infinity, max = -Infinity;
    for (const it of arr){ if (it.amount < min) min = it.amount; if (it.amount > max) max = it.amount; }
    const allEq = isFinite(min) && isFinite(max) && Math.abs(max - min) < 0.001;
    if (allEq){ for (const it of arr) roleByKey.set(it.key, 'eq'); }
    else {
      for (const it of arr){
        if (Math.abs(it.amount - min) < 0.001) roleByKey.set(it.key, 'low');
        else if (Math.abs(it.amount - max) < 0.001) roleByKey.set(it.key, 'high');
        else roleByKey.set(it.key, 'mid');
      }
    }
  }

  // Orden
  let sorted;
  if (sortMode === 'ticket') {
    sorted = currentItems.slice().sort((a,b) => {
      const oa = isFinite(a.origIndex) ? a.origIndex : Number.POSITIVE_INFINITY;
      const ob = isFinite(b.origIndex) ? b.origIndex : Number.POSITIVE_INFINITY;
      if (oa !== ob) return oa - ob;
      const da = normalizeDescKey(a.description);
      const db = normalizeDescKey(b.description);
      return da.localeCompare(db, 'es', { sensitivity:'base' });
    });
  } else {
    sorted = currentItems.slice().sort((a,b) => {
      const da = normalizeDescKey(a.description);
      const db = normalizeDescKey(b.description);
      const cmp = da.localeCompare(db, 'es', { sensitivity:'base' });
      if (cmp !== 0) return cmp;
      return (Number(a.amount)||0) - (Number(b.amount)||0);
    });
  }

  itemsByKey = new Map();
  let html = "";
  let total = 0;
  for(const r of sorted){
    const key = itemKey(r);
    itemsByKey.set(key, r);
    total += r.amount;

    const catId = categoryMap.get(key) || '';
    const catObj = categories.find(c => c.id === catId);
    const color = catObj ? catObj.color : '';
    const name  = catObj ? catObj.name  : '';
    const bg = color ? hexToRGBA(color, 0.22) : '';
    const style = color ? `style="--cat-color:${color}; --cat-bg:${bg}"` : '';
    const rowClass = catId ? 'row-assigned' : '';
    const role = (roleByKey.get(key) || '');
    const flag = priceFlagForRole(role);

    html += `<tr data-key="${escapeHtml(key)}"
                 data-manual-id="${r.manualId ? escapeHtml(String(r.manualId)) : ''}"
                 data-cat-id="${catId}"
                 class="${rowClass}"
                 ${style}>
      <td class="mono">
        ${r.manualId
          ? `<button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar l√≠nea manual">‚úñ</button>`
          : `${escapeHtml(String(r.quantity))}`
        }
      </td>
      <td class="td-desc">
        <a class="desc-link" href="${buildSearchURL(r.description)}" target="_blank" rel="noopener">
          ${flag}<span class="desc-text">${escapeHtml(r.description)}</span>
        </a>
      </td>
      <td class="cat-cell">
        ${catId
          ? `<span class="cat-dot" style="background:${color}" title="${escapeHtml(name)}"></span>`
          : `‚Äî`
        }
      </td>
      <td class="text-end mono">${toEUR(r.amount)}</td>
    </tr>`;
  }
  html += `<tr class="table-light">
    <td></td>
    <td class="fw-bold">TOTAL</td>
    <td></td>
    <td class="text-end mono fw-bold">${toEUR(total)}</td>
  </tr>`;
  $tbl.innerHTML = html;

  updateCategorySummary();
  updateExportButtonState();
  return total;
}

/* ------------ RESUMEN Y COPIAR TOTALES ------------ */
function updateCategorySummary() {
  const sums = {};
  for (const c of categories) sums[c.id] = { n:0, total:0, color:c.color, name:c.name };
  for (const [key, catId] of categoryMap.entries()) {
    const it = itemsByKey.get(key);
    if (!it || !(catId in sums)) continue;
    sums[catId].n += 1;
    sums[catId].total += Number(it.amount) || 0;
  }
  const parts = categories.map(c=>{
    const s = sums[c.id];
    return `<span class="tag" data-total="${toEUR(s.total)}" title="Click para copiar total de ${escapeHtml(c.name)}" style="border-color:${c.color}22;">
              <span class="cat-swatch" style="background:${c.color}"></span>
              <strong style="color:${c.color}">${escapeHtml(c.name)}</strong>
              <span class="n">(${s.n}) ${toEUR(s.total)}</span>
            </span>`;
  }).join('');
  $catsum.innerHTML = '<div class="catsum-grid">' + parts + '</div>';
}
$catsum.addEventListener('click', async (ev) => {
  const tag = ev.target.closest('.tag');
  if (!tag) return;
  const val = tag.getAttribute('data-total') || '';
  try {
    await navigator.clipboard.writeText(val);
    const old = tag.innerHTML;
    tag.innerHTML = old + ' <span class="ms-1">üìã</span>';
    setTimeout(() => { tag.innerHTML = old; }, 1000);
  } catch(e){
    alert('No se pudo copiar al portapapeles');
  }
});

/* ------------ EXPORTAR COMO IMAGEN ------------ */
function buildExportCard(catObj, items) {
  const wrap = document.createElement('div');
  wrap.className = 'export-card';
  const total = items.reduce((a,b)=> a + (Number(b.amount)||0), 0);
  wrap.innerHTML = `
    <h2 style="color:${catObj.color}">Lista ${escapeHtml(catObj.name)}</h2>
    <table>
      <thead>
        <tr>
          <th style="width:100px;">N¬∫</th>
          <th>Descripci√≥n</th>
          <th class="right" style="width:150px;">Importe (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(it => `
          <tr>
            <td class="mono">${escapeHtml(String(it.quantity))}</td>
            <td>${escapeHtml(String(it.description))}</td>
            <td class="right mono">${toEUR(Number(it.amount))}</td>
          </tr>
        `).join('')}
        <tr>
          <td></td>
          <td class="total">TOTAL</td>
          <td class="right mono total">${toEUR(total)}</td>
        </tr>
      </tbody>
    </table>
  `;
  return wrap;
}
async function exportCategoryImages() {
  if (!window.html2canvas) { alert('No se pudo cargar html2canvas.'); return; }
  if (lastCheckOk === false) {
    const msg = `‚ö†Ô∏è El total calculado (${toEUR(lastCalc)}) NO coincide con el del archivo (${toEUR(lastExpected)}).\n\n¬øQuieres exportar igualmente?`;
    if (!confirm(msg)) return;
  }
  const byCat = {};
  for (const c of categories) byCat[c.id] = [];
  for (const tr of document.querySelectorAll('#tbl tbody tr[data-key]')) {
    const key = tr.getAttribute('data-key');
    if (!key) continue;
    const catId = categoryMap.get(key);
    const it = itemsByKey.get(key);
    if (catId && it && byCat[catId]) byCat[catId].push(it);
  }
  const wrapper = document.createElement('div');
  wrapper.style.width = '980px';
  wrapper.style.background = '#fff';
  wrapper.style.padding = '16px';
  wrapper.style.border = '1px solid #e5e7eb';
  wrapper.style.borderRadius = '12px';
  wrapper.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';

  const title = document.createElement('h1');
  title.textContent = 'Resumen por categor√≠as';
  title.style.fontSize = '22px';
  title.style.margin = '0 0 10px';
  wrapper.appendChild(title);

  const meta = document.createElement('div');
  meta.textContent = new Date().toLocaleString('es-ES');
  meta.style.color = '#6b7280';
  meta.style.fontSize = '12px';
  meta.style.marginBottom = '12px';
  wrapper.appendChild(meta);

  let added = 0;
  for (const c of categories) {
    const arr = byCat[c.id] || [];
    if (!arr.length) continue;
    const card = buildExportCard(c, arr);
    card.style.marginBottom = '16px';
    wrapper.appendChild(card);
    added++;
  }
  if (!added) { alert('No hay categor√≠as con elementos para exportar.'); return; }

  $exportRoot.appendChild(wrapper);
  const canvas = await html2canvas(wrapper, { backgroundColor: '#ffffff', scale: 2, useCORS: true });
  const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
  const url = URL.createObjectURL(blob);
  // Abrir una nueva pesta√±a con la imagen generada
  const win = window.open();
  if (win) {
    const img = new Image();
    img.src = url;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    win.document.title = 'Resumen de categor√≠as';
    win.document.body.style.margin = '0';
    win.document.body.style.background = '#fff';
    win.document.body.appendChild(img);
  } else {
    alert('El navegador bloque√≥ la ventana emergente. Permite pop-ups para ver la imagen.');
  }
  wrapper.remove();
}

/* ------------ ESTADO EXPORT & ENLACE DESC ------------ */
function updateExportButtonState() {
  const rows = Array.from(document.querySelectorAll('#tbl tbody tr[data-key]'));
  if (rows.length === 0) {
    $btnExport.disabled = true;
    $btnExport.title = 'No hay productos para exportar';
    return;
  }
  let assigned = 0;
  for (const tr of rows) {
    const key = tr.getAttribute('data-key');
    if (key && categoryMap.has(key)) assigned++;
  }
  const allAssigned = assigned === rows.length;
  $btnExport.disabled = !allAssigned;
  $btnExport.title = allAssigned
    ? 'Exportar una √∫nica imagen con todas las categor√≠as'
    : 'Asigna categor√≠a a todas las filas para exportar';
}

// Evitar que el clic en el enlace de la descripci√≥n asigne categor√≠a
document.getElementById('tbl').addEventListener('click', (ev) => {
  const a = ev.target.closest('.td-desc a.desc-link');
  if (a){
    ev.stopPropagation(); // deja que el enlace funcione sin asignar fila
    return;
  }
}, true);

/* ------------ CLIC EN FILA (asignaci√≥n) ------------ */
document.getElementById('tbl').addEventListener('click', (ev) => {
  const tr = ev.target.closest('tr[data-key]');
  if (!tr) return;
  if (ev.target.closest('.btn-del')) return;
  if (ev.target.closest('a.desc-link')) return;
  const key = tr.getAttribute('data-key');
  if (!key) return;

  if (!activeCategoryId) {
    if (categoryMap.has(key)) categoryMap.delete(key);
  } else {
    const prev = categoryMap.get(key);
    if (prev === activeCategoryId) categoryMap.delete(key);
    else categoryMap.set(key, activeCategoryId);
  }
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
});
document.getElementById('tbl').addEventListener('dblclick', (ev) => {
  const tr = ev.target.closest('tr[data-key]');
  if (!tr) return;
  const key = tr.getAttribute('data-key');
  if (!key) return;
  if (categoryMap.has(key)) categoryMap.delete(key);
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
});

// Eliminar l√≠nea manual
document.getElementById('tbl').addEventListener('click', (ev) => {
  const del = ev.target.closest('.btn-del');
  if (!del) return;
  const tr = del.closest('tr');
  if (!tr) return;
  const mid = tr.getAttribute('data-manual-id');
  if (!mid) return;

  const idx = manualItems.findIndex(it => String(it.manualId) === String(mid));
  if (idx === -1) return;
  const it = manualItems[idx];
  const k = itemKey(it);
  if (categoryMap.has(k)) categoryMap.delete(k);
  manualItems.splice(idx, 1);
  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);
}, true);

/* ------------ PDF -> TEXTO ------------ */
async function pdfToTextLines(buf){
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const lines = [];
  let textItems = 0;
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    textItems += (content.items||[]).length;
    const byY = new Map();
    for(const it of content.items){
      const str = it.str || "";
      const tr = it.transform; const y = tr ? tr[5] : 0; const x = tr ? tr[4] : 0;
      const key = Math.round(y/2);
      if(!byY.has(key)) byY.set(key, []);
      byY.get(key).push({x, text: str});
    }
    const ys = Array.from(byY.keys()).sort((a,b)=>b-a);
    for(const y of ys){
      const chunks = byY.get(y).sort((a,b)=>a.x-b.x).map(c=>c.text);
      const line = chunks.map(c=>String(c||"").trim()).join(" ").replace(/\s{2,}/g," ").trim();
      if(line) lines.push(line);
    }
  }
  return {lines, textItems};
}

/* ------------ OCR (fallback) ------------ */
async function pdfToTextLinesOCR(buf){
  if(!window.Tesseract) throw new Error("No se carg√≥ Tesseract.js");
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const lines = [];
  for(let p=1;p<=pdf.numPages;p++){
    setProgress(`OCR p√°gina ${p}/${pdf.numPages}‚Ä¶`);
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({scale: 2});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', {willReadFrequently:true});
    canvas.width = Math.ceil(viewport.width);
    canvas.height = Math.ceil(viewport.height);
    await page.render({canvasContext:ctx, viewport}).promise;
    const dataUrl = canvas.toDataURL('image/png');
    const res = await Tesseract.recognize(dataUrl, 'spa+eng', { logger: () => {} });
    const text = res.data && res.data.text ? res.data.text : "";
    const pageLines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    lines.push(...pageLines);
  }
  return lines;
}

/* ------------ HEUR√çSTICAS ------------ */
function normalizeLine(s){
  s = String(s||"");
  s = s.replace(/(\d)[oO](\d)/g, '$10$2');
  s = s.replace(/,(\d)[sS]\b/g, ',$15');
  s = s.replace(/,(\d)[oO]\b/g, ',$10');
  s = s.replace(/\s*[‚Ç¨\u0080]\s*/g, ' ‚Ç¨');
  s = s.replace(/\s{2,}/g,' ').trim();
  return s;
}
function findLastPrice(str){
  const s = normalizeLine(str);
  const m = s.match(/(\d{1,3}(?:\.\d{3})*,\d{1,2})(?:\s*[‚Ç¨\u0080])?(?!.*\d)/);
  if (!m) return null;
  let val = m[1];
  if (/,\d$/.test(val)) val = val + '0';
  return val;
}
function nextNonEmpty(arr, i){
  let j = i+1;
  while(j < arr.length){
    const s = String(arr[j]||"").trim();
    if (s) return { index: j, text: s };
    j++;
  }
  return { index: -1, text: "" };
}
function filterProductsSection(lines){
  const L = lines.map(s => normalizeLine(String(s||"").trim()));
  const looksLikeProduct = (s, next) =>
    /^\s*\d+\s+.+\s+\d+,\d{2}(?:\s+\d+,\d{2})?\s*$/.test(s) ||
    (/^\D{2,}$/.test(s) && /\b(kg|g|l)\b.*\d+,\d{2}.*\d+,\d{2}/i.test(next||"")) ||
    (/^\s*\d+\s+\D+/.test(s) && /\b(kg|g|l)\b.*\d+,\d{2}.*\d+,\d{2}/i.test((next||""))) ||
    (/^\s*\d+\s+\D+/.test(s) && !!findLastPrice(next||""));

  let start = -1, end = L.length;
  for (let i=0;i<L.length;i++){
    const s = L[i] && L[i].trim();
    if (!s) continue;
    if (/^TOTAL\b/i.test(s) || /^TOTAL\s*[:‚Ç¨]/i.test(s) || /^TOTAL\s+(\d+|\d{1,3}(\.\d{3})*,\d{2})/i.test(s)) {
      end = i; break;
    }
  }
  for (let i=0;i<end;i++){
    const s = L[i] && L[i].trim(); if(!s) continue;
    const { text: next } = nextNonEmpty(L, i);
    if (looksLikeProduct(s, next)) { start = i; break; }
  }
  if (start >= 0) return L.slice(start, end).filter(Boolean);
  return L.filter(Boolean);
}
function parseProducts(lines){
  const isNoise = (s) => /(IVA\b|BASE IMPONIBLE|CUOTA\b|TARJ|MASTERCARD|EFECTIVO|FACTURA|SE ADMITEN DEVOLUCIONES|CAMBIO)/i.test(s);
  const clean = (s) => String(s||"").replace(/\s{2,}/g," ").trim();

  const out = [];
  const push = (q, d, u, a) => {
    const quantity = Number(String(q).replace(",", "."));
    const amount = toNumberEUR(a);
    let unit = u ? toNumberEUR(u) : NaN;
    if(!isFinite(unit) || unit<=0){ unit = quantity>0 ? amount/quantity : amount; }
    if(!isFinite(quantity) || quantity<=0 || !isFinite(amount)) return;
    if(!d || d.length<2) return;
    out.push({quantity, description:d, unit:Number(unit.toFixed(2)), amount:Number(amount.toFixed(2))});
  };

  const N = lines.map(clean).map(normalizeLine).filter(Boolean);

  for(let i=0;i<N.length;i++){
    const row = N[i];
    if (/^TOTAL\b/i.test(row) || /^TOTAL\s*[:‚Ç¨]/i.test(row)) break;
    if (isNoise(row)) continue;

    let m = row.match(/^\s*(\d+)\s+(.+?)\s+(\d+,\d{2})(?:\s*[‚Ç¨\u0080])?\s+(\d+,\d{2})(?:\s*[‚Ç¨\u0080])?.*$/);
    if(m){ push(m[1], m[2], m[3], m[4]); continue; }

    m = row.match(/^\s*(\d+)\s+(.+?)\s+(\d+,\d{2})(?:\s*[‚Ç¨\u0080])?.*$/);
    if(m){ push(m[1], m[2], null, m[3]); continue; }

    if(/^\D{2,}$/.test(row)){
      const { index: j, text: next } = nextNonEmpty(N, i);
      if (j !== -1) {
        const m2 = next.match(/^\s*([\d.,]+)\s*(kg|g|l)\b.*?(\d+,\d{2}).*?(\d+,\d{2})\s*$/i);
        if(m2){
          const qtyW = Number(m2[1].replace(",", "."));
          push(qtyW, row, m2[3], m2[4]);
          i = j;
          continue;
        }
      }
    }

    m = row.match(/^\s*(\d+)\s+(.+?)\s*$/);
    if(m){
      const desc = m[2];
      const { index: j, text: next } = nextNonEmpty(N, i);
      if (j !== -1) {
        const m2 = next.match(/^\s*([\d.,]+)\s*(kg|g|l)\b.*?(\d+,\d{2}).*?(\d+,\d{2})\s*$/i);
        if (m2){
          const qtyW = Number(m2[1].replace(",", "."));
          push(qtyW, desc, m2[3], m2[4]);
          i = j;
          continue;
        }
      }
    }

    // "1 DESCRIPCI√ìN" + siguiente con precio al final
    m = row.match(/^\s*(\d+)\s+(.+?)\s*$/);
    if (m) {
      const qty = m[1];
      const desc = m[2];
      const { index: j, text: next } = nextNonEmpty(N, i);
      if (j !== -1) {
        const p = findLastPrice(next);
        if (p) {
          push(qty, desc, null, p);
          i = j;
          continue;
        }
      }
    }

    const euros = row.match(/\d+,\d{2}/g);
    if(euros && euros.length>=1){
      const amount = euros[euros.length-1];
      const unit = euros.length>=2 ? euros[euros.length-2] : null;
      const leadQty = row.match(/^\s*(\d+)\s+/);
      const qty = leadQty ? Number(leadQty[1]) : 1;
      const cut = row.lastIndexOf(amount);
      let desc = row.substring(leadQty ? leadQty[0].length : 0, cut).trim();
      if(!desc) desc = row.replace(new RegExp(amount+"\\s*$"), "").trim();
      if (/^(TOTAL|IVA|BASE IMPONIBLE|CUOTA)\b/i.test(desc)) continue;
      push(qty, desc, unit, amount);
      continue;
    } else {
      const p = findLastPrice(row);
      if (p) {
        const leadQty = row.match(/^\s*(\d+)\s+/);
        const qty = leadQty ? Number(leadQty[1]) : 1;
        const cut = row.lastIndexOf(p);
        let desc = row.substring(leadQty ? leadQty[0].length : 0, cut).trim();
        if(!desc) desc = row.replace(new RegExp(p+"\\s*$"), "").trim();
        if (!/^(TOTAL|IVA|BASE IMPONIBLE|CUOTA)\b/i.test(desc)) {
          push(qty, desc, null, p);
          continue;
        }
      }
    }
  }
  return out;
}

function extractMeta(lines){
  const txt = lines.join("\n");
  const date = (txt.match(/\b(\d{2}\/\d{2}\/\d{4})\b/)||[])[1] || "";
  const time = (txt.match(/\b(\d{2}:\d{2})\b/)||[])[1] || "";
  const tienda = (txt.match(/MERCADONA/i) ? "Mercadona" : "");
  $meta.textContent = [tienda && `Comercio: ${tienda}`, (date||time) && `Fecha/Hora: ${date} ${time}`].filter(Boolean).join("\n");
}

/* ------------ PROCESO PRINCIPAL ------------ */
async function processSelectedFile(){
  const f = $file.files && $file.files[0];
  if(!f){ return; }
  if(!/\.pdf$/i.test(f.name)){ alert("Debe ser un PDF."); return; }
  try{
    setProgress("Cargando PDF...");
    const buf = new Uint8Array(await f.arrayBuffer());
    let lines = [];
    const {lines: lns, textItems} = await pdfToTextLines(buf);
    lines = lns;
    if(!lines.length || textItems===0){
      setProgress("Sin texto embebido. Haciendo OCR‚Ä¶");
      lines = await pdfToTextLinesOCR(buf);
    }
    setProgress("Extrayendo productos‚Ä¶");
    extractMeta(lines);
    const section = filterProductsSection(lines);
    const items = parseProducts(section);
    categoryMap.clear();
    manualItems = [];
    baseItems = items.slice();
    baseItems.forEach((it, idx) => { it.origIndex = idx; });
    const total = setTable(baseItems);
    setCheck(f.name, total);
    setProgress("");
  } catch (e){
    console.error(e);
    alert("No se pudo procesar el PDF.");
    setProgress("");
  }
}

/* ------------ UI CORRECCI√ìN MANUAL ------------ */
function getRemaining(){
  if (!isFinite(lastExpected) || !isFinite(lastCalc)) return 0;
  return lastExpected - lastCalc;
}
function updateManualFixUI(){
  const box = document.getElementById('manualFix');
  const msg = document.getElementById('diffMsg');
  const amtInput = document.getElementById('mfAmount');
  const canCompare = isFinite(lastExpected) && isFinite(lastCalc);
  if (!box || !msg || !amtInput) return;
  if (!canCompare){
    box.classList.add('d-none');
    return;
  }
  const diff = getRemaining();
  const abs = Math.abs(diff);
  const falta = diff > 0.005;
  const sobra = diff < -0.005;

  if (falta) {
    msg.innerHTML = `<div class="alert alert-warning py-2 my-0" role="alert">
      Falta <strong>${toEUR(abs)}</strong> para cuadrar con el total del archivo.
    </div>`;
    const valNow = toNumberEUR(amtInput.value);
    if (!isFinite(valNow) || valNow <= 0) amtInput.value = toEUR(abs);
    document.getElementById('btnAddManual').disabled = false;
    box.classList.remove('d-none');
  } else if (sobra) {
    msg.innerHTML = `<div class="alert alert-danger py-2 my-0" role="alert">
      Sobra <strong>${toEUR(abs)}</strong> respecto al total del archivo. Revisa las l√≠neas detectadas.
    </div>`;
    amtInput.value = toEUR(0);
    document.getElementById('btnAddManual').disabled = true;
    box.classList.remove('d-none');
  } else {
    box.classList.add('d-none');
    return;
  }
}

/* ------------ Dropdown manual con colores ------------ */
function renderManualCatDropdown(){
  const wrap = document.getElementById('mfCatWrap');
  const hidden = document.getElementById('mfCatVal');
  if (!wrap || !hidden) return;

  const def = activeCategoryId || (categories[0] && categories[0].id) || '';
  const defObj = categories.find(c => c.id === def) || categories[0] || {id:'', name:'', color:'#888'};
  hidden.value = defObj.id;

  wrap.innerHTML = `
    <button class="btn btn-outline-secondary dropdown-toggle cat-dd-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      <span class="cat-dd-label">
        <span class="cat-dd-dot" style="background:${defObj.color}"></span>
        <span class="cat-dd-name">${escapeHtml(defObj.name)}</span>
      </span>
    </button>
    <ul class="dropdown-menu w-100">
      ${categories.map(c => `
        <li>
          <button type="button" class="dropdown-item cat-dd-item" data-id="${c.id}" data-color="${c.color}">
            <span class="cat-dd-dot" style="background:${c.color}"></span>
            <span>${escapeHtml(c.name)}</span>
          </button>
        </li>
      `).join('')}
    </ul>
  `;

  wrap.querySelectorAll('.cat-dd-item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      const color = btn.getAttribute('data-color');
      const name = btn.textContent.trim();
      hidden.value = id;
      const lab = wrap.querySelector('.cat-dd-name');
      const dot = wrap.querySelector('.cat-dd-dot');
      if (lab) lab.textContent = name;
      if (dot) dot.style.background = color;
    });
  });
}

/* ------------ EVENTOS ------------ */
$file.addEventListener('change', processSelectedFile);

// Saneo en vivo del importe manual
const $mfAmount = document.getElementById('mfAmount');
$mfAmount.addEventListener('input', () => {
  const n = sanitizeAmountInput($mfAmount.value);
  const rem = getRemaining();
  const over = isFinite(n) && n - rem > 0.005;
  $mfAmount.classList.toggle('is-invalid', !!over);
});
$mfAmount.addEventListener('blur', () => {
  const n = sanitizeAmountInput($mfAmount.value);
  if (isFinite(n) && n > 0) $mfAmount.value = toEUR(n);
});

// A√±adir l√≠nea manual
document.getElementById('manualForm').addEventListener('submit', (ev) => {
  ev.preventDefault();
  const desc = document.getElementById('mfDesc').value.trim();
  const cat = document.getElementById('mfCatVal').value;
  const amtStr = document.getElementById('mfAmount').value;
  const amtNum = sanitizeAmountInput(amtStr);
  const rem = getRemaining();

  if (!desc) { alert('Introduce una descripci√≥n.'); return; }
  if (!isFinite(amtNum) || amtNum <= 0){ alert('Importe inv√°lido.'); return; }
  if (!(rem > 0.005)) { alert('Ahora mismo no falta importe (o sobra).'); return; }
  if ((amtNum - rem) > 0.005) {
    alert(`El importe supera lo que falta por ajustar (${toEUR(rem)}).`);
    return;
  }

  const it = {
    quantity: 1,
    description: desc,
    unit: amtNum,
    amount: amtNum,
    manualId: Date.now() + '_' + Math.random().toString(36).slice(2,7),
    origIndex: Number.POSITIVE_INFINITY
  };
  manualItems.push(it);

  const key = itemKey(it);
  if (cat) categoryMap.set(key, cat);

  const total = setTable(baseItems);
  lastCalc = total;
  setCheck(lastFilename || '', total);

  document.getElementById('mfDesc').value = '';
  const newRem = getRemaining();
  document.getElementById('mfAmount').value = newRem > 0.005 ? toEUR(newRem) : toEUR(0);
  document.getElementById('mfDesc').focus();
});

// Export
$btnExport.addEventListener('click', exportCategoryImages);

// Auto-abrir picker + inicializar
document.addEventListener('DOMContentLoaded', () => {
  const openPicker = () => {
    try {
      if (!$file.files || $file.files.length === 0) {
        if (typeof $file.showPicker === 'function') $file.showPicker();
        else $file.click();
      }
    } catch(e){}
  };
  setTimeout(openPicker, 300);
  const onceOpen = () => { openPicker(); window.removeEventListener('pointerdown', onceOpen); window.removeEventListener('keydown', onceOpen); };
  window.addEventListener('pointerdown', onceOpen, { once:true });
  window.addEventListener('keydown', onceOpen, { once:true });

  loadCategories();
  renderCatBar();
  updateManualFixUI();
  renderManualCatDropdown();
  updateNavSpacer();
  window.addEventListener('resize', updateNavSpacer);

  if ($catAddBtn) $catAddBtn.addEventListener('click', () => openCategoryEditor(null, 'create'));

  // Bot√≥n de orden en cabecera
  const $btnSort = document.getElementById('btnSort');
  if ($btnSort) {
    const refreshLabel = () => { $btnSort.textContent = (sortMode === 'alpha') ? 'A‚ÜíZ' : 'Ticket'; };
    refreshLabel();
    $btnSort.addEventListener('click', () => {
      sortMode = (sortMode === 'alpha') ? 'ticket' : 'alpha';
      refreshLabel();
      const total = setTable(baseItems);
      lastCalc = total;
      setCheck(lastFilename || '', total);
    });
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
